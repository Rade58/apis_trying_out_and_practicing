# OVDE CU PREDSTAVITI NEKE STRATEGIJE CACHE-IRANJA

NAIME, RANIJE SAM GOVORIO, DA SE NE MORA CACHE-IRANJA OBAVLJATI SAMO U ServiceWorkerGlobalScope-U

VEC DA TO MOZE BITI I NEKI JAVASCRIPT FAJL, KOJI JE UCITAN U MOJ PAGE

ZATO CU UPRAVO PREDSTAVITI STRATEGIJU, PO KOJOJ KORISNIK KLIKOM MOZE IZABRATI DA NESTO SACUVA ZA OFFLINE USE (TO MOZE BITI NEKI ARTTICLE)

## ON DEMAND CACHING

U MOM PRIMERU, KOJEG RADIM DOK SE BAVIM PROGRESIVNIM WEB APLIKACIJAMA, DODACU JEDAN CARD, I NA TOM CARD-U CE BITI NEKI FETCHED PODACI, KONKRETNO JEDNA SLIKA, I IME NEKOG GRADA

POMENUTI CARD CE IMATI I DUGME KOJIM, KORISNIK MOZE SAVE-PVATI, POMENUTI CARD FOR OFFLINE USE

I NA TAJ NACIN CU KREIRATI, TAKOZVANI ON DEMAND CACHING, DAKLE KORISNIK CE CACHIRATI, ONO STO ON ZELI

OVO JE NA PRIMER DOBRO URADITI, KOD NEKE STRANICE, SA MNOSTVOM CLANAKA, I NA TAJ NACIN KORISNIK, MOZE SACUVATI ONE CLANKE KOJE ZELI ZA OFFLINE USE

MOJ feed.js KOJI IMA PRISTUP DOM-U **CE ZA POCETAK IZGLEDATI OVAKO** (JOS NECU DEFINISATI CACHIN, OVO JE SAMO POSTAVKA):

```javascript
// DAKLE KRECEM SA DEFINISANJEM FUNKCIJE ZA KREIRANJE CARD-A

const createCard = function(){
    const cardWrapper = document.createElement('div');
    cardWrapper.classList.add('momenti_kartica');
    // O MATERIAL LITE KARTICMA, MOGU OVDE SAZNATI VISE   https://getmdl.io/components/index.html#cards-section
    cardWrapper.classList.add('mdl-card');
    cardWrapper.classList.add('mdl-shadow--2dp');
    cardWrapper.style.margin = 'auto';

    // NASLOV
    const titleEl = document.createElement('div');
    titleEl.classList.add('mdl-card__title');
    // OBRATI PAZNJU DA OVO TRIGGER-UJE NETWORK REQUEST
    titleEl.style.backgroundImage = 'url("/src/images/lima.jpg")';
    titleEl.style.height = "180px";

    const cardTitleTextEl = document.createElement('h2');
    cardTitleTextEl.classList.add('mdl-card__title-text');
    cardTitleTextEl.textContent = 'Limassol trip';
    cardTitleTextEl.style.color = 'white';

    const cardSupportTextEl = document.createElement('div');
    cardSupportTextEl.classList.add('mdl-card__supporting-text');
    cardSupportTextEl.textContent = 'in Limassol';

    // KADA KORISNIK PRITISNE SLEDECE DUGME TREBALO BI DA DEFINISE DA SE CARD CUVA OFFLINE
    // STO CU KASNIJE DEFINISATI
    const cardSaveButton = document.createElement('button');
    cardSaveButton.textContent = 'Save';

    titleEl.appendChild(cardTitleTextEl);
    cardWrapper.appendChild(titleEl);
    cardSupportTextEl.appendChild(cardSaveButton);

    cardWrapper.appendChild(cardSupportTextEl);

    // A MATERIAL LITE STRANICE      https://getmdl.io/started/
    // Material Design Lite will automatically register and render all elements marked with MDL classes
    // upon page load. However in the case where you are creating DOM elements dynamically you need to 
    // register new elements using the upgradeElement function.
    componentHandler.upgradeElement(cardWrapper);
    // PREDPOSTAVLJAM DA SAM PREDHODNO DODAO ZATO DA ELEMENTI IMAJU EFEKAT KOJI JE DODAT JAVASCRIPT-OM
    // JAVASCRIPT BIBLIOTEKE SE VEC UCITAO, A JA DINAMICKI KREIRAM OVE ELEMENTE, TAKO DA ONI NECE
    // IMATI ZAKACENE BIBLIOTEKINE HANDLERE (PREDPOSTAVLJAM SAMO ONAJ VEZAN ZA RIPPLE EFFECT)
    // KORISCENJEM POMENUTE FUNKCIJE GORE, DODAJE SE JAVASCRIPT NA MOM DINAMICKI KREIRANO MELEMENTU

    // KARTICA TREBA DA SE KACI U #shared-moments OBLAST MOJE APLIKACIJE
    document.querySelector('div#shared-moments').appendChild(cardWrapper);
};

// SIMULIRACU DA SE KARTICA KREIRA, KAO POSLEDICA FETCHING-A PODATAKA

fetch('https://httpbin.org/get')
.then(function(response){
    return response.json();
})
.then(function(data){
    createCard();
})

// ALI JA ZELIM DA KORISNIK BIRA DA LI ZELI DA CACHEIRA SLEDECE

//         -    Response PREDHODNOG fetch POZIVA

//         -    I Response SLIKE, KOJA SE PRIKAZUJE U CARDU
```

**MORAM REDEFINISATI CODE SERVICE WORKER-A**

KONKRETNO MORAM UKLONITI DYNAMIC CACHING U SLUCAJU MOJE, DVA GORE PREDHODNO POMENUTA Response-A

A SERVING OSTAJE ISTI

sw.js FAJL:

```javascript
self.addEventListener('fetch', function(ev){

    // KREIRAM URL INSTANCU, SAMO ZBOG pathname PROPERTIJA
    // ZATO STO BIH INACE MORAO DA KORISTIM CEO url MOG DOMENA ,A OVAKO IMAM pathname OPECIJU
    const urlIns = new URL(ev.request.url)

    ev.respondWith(
        self.caches.match(ev.request)
        .then(function(response){
            if(response){
                return response;
            }else{
                return self.fetch(ev.request)
                .then(function(resp){

                    return self.caches.open(DYNAMIC_CACHE)
                    .then(function(dynamicCache){
                        // DAKLE OVO JE USLOVNA IZJAVA KOJU SAM DODAO U MOM PRIMERU
                        // KAKO BI SPRECIO CACHING DVA POMENUTA RESURSA
                        // JA NE ZNAM DA LI JE OVO DOBRA PRAKSA ALI U OVOM MOM PRIMERU CE POSLUZITI
                        if(urlIns.pathname !== '/src/images/lima.jpg' && ev.request.url !== 'https://httpbin.org/get'){
                            dynamicCache.put(ev.request.url, resp.clone());
                        }

                        return resp;
                    })

                })
                .catch(function(err){

                })
            }
        })
    );

});

// MORAM WHITELIST-OVATI I NOVI CACHE, KOJI CE SE ZVATI             'on-demand-cache-v1'

self.addEventListener('activate', function(ev){

    ev.waitUntil(
        self.caches.keys()
        .then(function(keys){
            return Promise.all(
                keys.map(function(cacheName){
                    if(cacheName !== STATIC_CACHE && cacheName !== DYNAMIC_CACHE && caheName !== 'on-demand-cache-v1'){  // SADA NI ON DEMAND CACHE NECE BITI OBRISAN
                                                                                    // AKO CACHE-I NEMAJU IMENA, KOJA REFERENCIRAJU DVE
                                                                                    // VARIJABLE
                        return self.caches.delete(cacheName);                       // UKLOANJAM IH
                    }
                })
            )
        })
    );
});

```

**A SADA CU DEFINISATI TAJ ONDEMAND CACHING**

DAKLE VRACAM SE U MOJ feed.js FAJL I DEFINISEM SLEDECE

```javascript
// OVO CE BITI STRING IMENA ON DEMAND CACHE-A, KOJI SAM WHITELIST-OVAO U SERVICE WORKERU, CISTO DA GA NE BI OBRISAO
const ON_DEMAND_CACHE = 'on-demand-cache-v1'

// DAKLE ONO STO MORAM DEFINISATI, JESTE EVENT HANDLER KOJE CU ZAKACITI NA BUTTON MOG CARDA
// A TAJ HANDLER TREBA TRIGGER-OVATI

const cachingFunc = function(ev){

    // DOBRO JE OVDE NAPRAVITI I PROVERU U POGLEDU TOGA DA LI BROWSER PODRZAVA caches
    if('caches' in window){
        // OVDE OTVARAM ON_DEMAND_CACHE
        window.caches.open(ON_DEMAND_CACHE)
        .then(function(cache){
            cache.addAll(['/src/images/lima.jpg', 'https://httpbin.org/get']);
        })
    }

    ev.currentTarget.remove();
    ev.currentTarget.onclick = null;
}



const createCard = function(){
    const cardWrapper = document.createElement('div');
    cardWrapper.classList.add('momenti_kartica');
    cardWrapper.classList.add('mdl-card');
    cardWrapper.classList.add('mdl-shadow--2dp');
    cardWrapper.style.margin = 'auto';
    const titleEl = document.createElement('div');
    titleEl.classList.add('mdl-card__title');
    titleEl.style.backgroundImage = 'url("/src/images/lima.jpg")';
    titleEl.style.height = "180px";
    const cardTitleTextEl = document.createElement('h2');
    cardTitleTextEl.classList.add('mdl-card__title-text');
    cardTitleTextEl.textContent = 'Limassol trip';
    cardTitleTextEl.style.color = 'white';
    const cardSupportTextEl = document.createElement('div');
    cardSupportTextEl.classList.add('mdl-card__supporting-text');
    cardSupportTextEl.textContent = 'in Limassol';
    const cardSaveButton = document.createElement('button');
    cardSaveButton.textContent = 'Save';
    titleEl.appendChild(cardTitleTextEl);
    cardWrapper.appendChild(titleEl);
    cardSupportTextEl.appendChild(cardSaveButton);
    cardWrapper.appendChild(cardSupportTextEl);
    componentHandler.upgradeElement(cardWrapper);
    document.querySelector('div#shared-moments').appendChild(cardWrapper);

    // KACENJE HANDLERA NA DUGME
    cardSaveButton.addEventListener('click', cachingFunc)

};

fetch('https://httpbin.org/get')
.then(function(response){
    return response.json();
})
.then(function(data){
    createCard();
})

```

SADA KADA KORISNIK MOZE CACHE-IRATI Response-OVE, KOIJE SAM GORE POMENUO, I TO MOZE URADITI PRITISKOM NA save DUGME U KARTICI