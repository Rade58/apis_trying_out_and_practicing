# OVDE CU DAKLE POPRAVITI CODE MOJE CLOUD FUNKCIJE, KOJA JE TREBALA DA RECEIVE-UJE FORM DATA; A PROBLEMI SU NASTALI ZBOG KORISCENJA PAKETA formidable; ON SE NAIME VISE NE MOZE KORISTITI, JER JE FIREBASE PRETRPEO NEKE PROMENE, O KOJIM CU GOVORITI TEK NA KRAJU OVOG FAJLA

PRE SVEGA JA CU OVDE OSTAVITI NEKE VALIDNE INFORMACIJE, KOJE SE TICU, KORISCENJA STORAGE-A

ALI OBRATICU PAZNJU I NA NEKE PROMENE, KOJE SU SE DESILE U FIREBASE-U

## MISLI MDA SAM JA U OVOM PROJEKTU KORISTIO FIREBASE NA STARI NACIN, A ONO STO NISAM URADIO JESTE INICIJALIZACIJA FIREBASE APP-A DIREKTNO U MOM PROJEKTU, CIME 'POVEZUJEM' MOJ APP SA FIREBASE-OM; STO MI OMOGUCAVA LAKSE KORISCENJE FIREBASE FEATURE-A U MOM APP, I LAKSE HANDLE-OVANJE NETWORK REQUEST-OVA U CLOUD FUNKCIJAMA, KOJE STIZU IZ MOG APP

KADA REGISTRUJEM MOJ APP KAO FIREBASE APP, NA PLATFORMI TO MI OLAKSAVA POSAO, JER SE NE MORAM BAVITI DODATNIM PROBLEMIMA

TO JE NAIME 'TWO WAY STREET' STO SE TICE CLOUD FUNKCIJA

IDEM U FIREBASE KONZOLU I BIRAM SETTING-SE (MALI ZUPCANIK)

ODATLE MOGU REGISTROVATI MOJ APP KAO FIREBASE WEB APLIKACIJU (MOGUCE SU OPCIJE I ZA NATIVE APP ITD)

U SUSTINI SVE MI JE PROVIDED

A TO STO JE PROVIDED POTREBNO JE EMBED-OVATI U MOJ PAGE

DAKLE KOPIRAM SLEDECE STVARI U MOJ PAGE, PRI DNU body ELEMENTA, PRE NEGO SE U BILO KOJIM SCRIPT-OVIMA MOJE APLIKACIJE, BUDE KOORISTIO FIREBASE

```HTML
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>

<!-- KADA MOJ APP CODE-IRAM UZ POMOC BUNDLER-A KAO STO JE WEBPACK, JASNO JE DA 
CU PREDHODNI SCRIPT UVOZITI KAO MODUL, ALI TO SAM OBJASNIO VEC U DRUGOM PROJEKTU
ZNAS VEC KOJEM -->

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#config-web-app -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {                                // OVDE SU BILE INFORMCIJE
                                                        // ALI NECU IH PRIKAZATI
                                                        // IAKO TO NISTA I NE ZNACI
                                                        // SMEJU DA BUDU PUBLIC

                                                        // ALI IPAK NAJBOLJE JE KADA KORISTIM NEKI 
                                                        // BUILD SISTEM KAO STO JE WEBPACK
                                                        // DA OVU KONFIGURACIJU UVEZEM KAO JSON
    apiKey: "AIzaSyB76KSNqmgZIJrzSd9QQis-ls",
    authDomain: "instapwBLAH.firebap.com",
    databaseURL: "https://instaBLAHne.firebaseio.com",
    projectId: "insta-pwa-clone",
    storageBucket: "insta-pwa-clone.appspot.com",
    messagingSenderId: "693903166",
    appId: "1:69379966:web:733c23ca6bdba"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>

<!-- OVDE SU MOJI OSTAL ISCRIPT-OVI IZ MOG PROJEKTA, A NEKI OD NJIH KORISTE FIREBASE -->
<!-- USTVARI SAMO SALJU REQUEST-OVE DO ENDPOINTA, ODNOSNO DO CLOUD FUNKCIJA -->

<script src="/src/js/material.min.js"></script>
<script src="/src/js/idb.js"></script>
<script src="/src/js/utility.js"></script>
<script src="/src/js/feed.js"></script>
<script src="/src/js/app.js"></script>

<!-- KRAJ body TAGA -->

```

## SADA ONO STO BI TREBALO DA BUDE LAKSE NA STRANI CLOUD FUNKCIJA, JESTE LAKSE HANDLE-OVANJE NEKIH REQUEST-OVA, KONKRETNO MISLIM DA NE MORAM KORISTITI @google-cloud/storage PAKET

NAIME DA NISAM UVEZAO GORNJU KONFIGURACIJU, MORAO BI NA PRIMER U CLOUD FUNKCI DEFINISATI CONFIG FAJL, DIREKTNO NAMENJEN TOM PAKETU

**MORAO BI KORISTITI NEKE DOWNLOAD TOKENE**

E PA TO SE SADA OBAVLJA IZA KULISA (KORISCENJEM POMENUTIH config INFORMACIJA) (MISLIM DA SAM TO NAPOMENUO I U DRUGOM PROJEKTU)

**NARAVNO POTREBNO JE INICJALIZOVATI APP I U functions/index.js FAJLU, ALI TO JE ZNATNO JEDNOSTAVNIJE** (USTVARI UPRAVO CE OVO RESITI PROBLEM TOKENA KOJI SE SALJU U SLUCAJU STORAGE-A)

I NECU MORATI KORISTITI POMENUTI GOOGLE STORAGE PAKET

## POCECU OD POCETKA, NAIME REDEFINISACU CEO functions/index.js FAJL, JER ZELIM DA UVEZEM TACNO ONE STVARI, KOJE CU KORISTITI, ZATIM CU SVE DEFINISATI I U SKLADU SA MODERNOM SINTAKSOM

>>> KADA DEPLOY-UJEM FUNKCIJE A NE KORISTIM MODERNU SINTAKSU, FIREBASE MI POKAZUJE WARNING-E
>>> PROVERI TAKODJE DA LI JE Node.js 8 U UPOTREBI ZA TVOJ PROJEKAT
>>> AKO NIJE UPDATE-UJ, ONAKO KAKO SAM TO POKAZAO U DRUGOM PROJEKTU

**MEDJUTIM HAJDE DA PRVO URADIM INSTALIRANJE I UPDAT-OVANJE PAKETA** (OVO MOGU RADITI U MOM package.json FAJLU) (NE ZNA MDA LI JE OVO ZATO STO SE ONI KORISTE NA CLIENT-U (NE SECAM SE DA LI SE KORTISTE NA CLIENT STRAN IAL ICU SAZNATI KASNIJE))

**NEKA URADICU TO I U MOM functions/package.json FAJLU, ALI I ONOM functions/package.json**

TAKODJE OVE PAKETE BI TREBAL ODA IMAM GLOBALNO (NE ZNAM ZASTO, ALI ZA SADA IH NECU INSTALIRATI GLOBALNO JER IH VEC IMAM), A UVEK ZELI MDA IH INSTALIRAM NA LATEST VERZIJU

DAKLE INSTALIRAM IH LOKALNO (MISLIM DA IH MOGU INSTALIRATI SAMO U package.json FAJLU)

ALI INSTALIRACU IH I U functions.package.json ,JER SU OD RANIJE TAMO INSTALIRANI, A JA ZELIM LATEST VERZIJU

- npm install firebase-functions@latest firebase-admin@latest --save

(ALI IPAK MISLIM DA SU POTRENE INSTALACIJE NA DVA MESTA, AKO ZELIM DA KORISTIM TE PAKETE LOKALNO ALI I ZA CLOUD-U (FUNCTIONS))

**TAKODJE CU U functions INSTALIRATI I [busboy](https://www.npmjs.com/package/busboy) PAKET**

- npm install --save busboy

**formidable MOZES UKLONITI**

- npm uninstall formidable --save

**PAKETE fs, os, path DOLAZE SA Node-OM, I NJIH SAMO UVOZIM**

**MOZES OPET DA UPDATE-UJE cors PAKET (functions FOLDER) (`npm install --save cors`)**

**OD RANIJE SI IMAO PAKETE web-push I TAKODE I uuid-v4 (OVAJ PAKET NIGDE NIJE REGITROVAN, ALI JE FUNKCIONISALA NJEGOVA UPOTREBA (NECU GA ISNTALIRATI NITUI UPDATE-OVATI (ON FUNKCIONISE, JER SAM GA KORISTIO U PROJEKTU OD RANIJE ALI NE VIDIM GA NIGDE (POSTOJE TAKODJE MNOGI DRUGI PAKETI ZA VAPID KLJUCEVE, ALI NJMA CU SE POZABAVITI NA NEKO MDRUGOM PROJEKTU))))**

SADA DA KONACNO POCNEM SA REDEFINISANJEM

functions/index.js FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
// dakle uveza osam dva pomenuta paketa

// SADA MOGU INICIJALIZOVATI APP I NA CLOUD STRANI, BAS KAO STO SAM OBECAO
admin.initializeApp(functions.config().firebase)

// UPRAVO CE POMENUTO OMOGUCITI DA LAKSE KORISTIM storage (NECU DAKLE MORATI KORISTITI @google-cloud/storage)

// HAJDE DA ODMAH UZEMEM STORAGE, NA KORISCENJE, I TO MOGU URADITI TAKO STO PRIMENIM storage
// FUNKCIJU NAD admin-OM
const storage = admin.storage();

// INSTALIRAO SAM RANIJE busboy (UKLONIO SAM formidable, ON MI NAIME NECE TREBATI)
// SAD GA UVOZIM
const Busboy = require('busboy');

// TREBACE MI I PAKETI KOJI SU VEC NATIVNI ZA Node.js
const file_system = require('fs')
const os = require('os');
const path = require('path');

// NARAVNO, KORISTICU cors
const cors = require('cors')({origin: true})

// OVO SU PAKETI KOJI SU NEOPHODNI ZA PUSH, AL ITO SAM OBJASNJAVAO RANIJE
const webpush = require('web-push');
const UUID = require('uuid-v4');            // IMAM OSECAJ DA OVAJ PAKET NESTO NE VALJA, AL IVIDECU
// TU SU I VAPID KLJUCEVI
const privateVapidKey = "oC8DBLahIEEzbmom6BtrF6z7_rVY";
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-v-vS_m122NEFkIgcDWDRgFzvr";
// NARAVNO KLUCEVI NISU PRAVI

// OVDE CU STATI SA DEFINISANJEM, JER ZELIM DA DEFINISEM SECURITY RULES ZA STORAGE
```

## DEFINISANJE SECURITY PRAVILA SA STORAGE

EVO KAKVA PRAVILA ZELIM DA DEFINISEM:

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    match /photos/{photoURL} {
        
        allow read;

        allow write;

    }
  
  }
}
```

DAKLE DOZVOLIO SAM READ I WRITE U SPECIFICIRANOM FOLDERU

**OBRATI PAZNJU DA SAM DEFINISAO PRAVILA ZA**

- photos FOLDER U, JEDINOM DEFAULT BUCKETU

- {photoURL} JE VARIJABLA I PREDSTAVLJA URL FAJLA (TACNIJE IME FAJLA U photos FOLDERU)

*TO IMAJ U VIDU JER CE TI TREBATI, KADA BUDES DEFINISAO UPLOAD FAJLA*

## STO SE TICE CLIENT SIDE CODE-A, JA SAM DEFINISAO DA SE PODACI SALJU KROZ indexedDB (OBJECT STORE 'sync-posts'); A IZ SERVICE WORKER-A, ON sync PODACI SE PROSLEDJUJU DO CLOUD FUNKCIJE; STO ZNACI DA SE 'POST' REQUEST OBAVLJA U OBIMU POMENUTOG ON sync HANDLER-A, GDE SE UZIMA DATA IZ OBJECT STORE-A, I PRAVI SE S NJIAM 'POST' REQUEST, ALI UZ KORISCENJE FormData INTERFACE-A

HAJDE DA OPET POGLEDAM CODE public/src/js/feed.js

ZELIM DA VIDIM CODE KOJI SE ODNOSI NA STAVLJANJE DATE U indexedDB U 'sync-posts' OBJECT STORE

```javascript
const sendData = function(){    // FALLBACK FUNKCIJA, KOJA SE POZIVA AKO BROWSER NE PODRZAVA BACKGROUND SYNC

    /* const dataObject = {
        id: new Date().toISOString(),
        title: titleInput.value,
        location: locationInput.value,
        image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
    } */

    // POMENUTI OBJEKAT MI DAKLE VISE NIJE POTREBAN, JER CU UMESTO NJEGA KORISTITI FormData

    const postData = new FormData();   // INSTANTICIZIRAO SAM GA

    // APPENDUJEM MU PRVO SVE PODATKE IZ TEKSTUALNIH INPUT-A (NARAVNO I id)

    postData.append('id', new Date().toISOString());
    postData.append('title', titleInput.value);
    postData.append('location', locationInput.value);

    // A SADA APPEND-UJEM I Blob (SKALDISTI GA picture GLOBALBNA VARIJABLA, KAO STO JE POZNATO);

    // 1. ARGUMENT JE KLJUC, A KLJUC KOJI CE BITI NJEGOV (Blob-OV), U FORM DATA-U, NEKA SE ZOVE file, POSTO TAJ Blob REPREREZENTUJE FILE SLIKE
    // A MOGA OSAM ZADATI BILO KOJI KLJUC

    // 2. ARGUMENT, JESTE Blob INSTANCA naravno

    // 3. ARGUMENT JE IME KOJE ZELIM DA IMA, FAJL, KOJI POMENUTI BLOB REPREZENTUJE 

                // NEKA TO IME BUDE FORMIRANO OD ONIH PODATKAK KOJE SU FORMIARALI id

                // PLUS MIME TYPE FAJLA, KOJEG REPREZENTUJE Blob (OVO SE ODNOSI NA FORMAT SLIKE (jpg, jpeg, png..))

    postData.append(
        'file',
        picture,
        postData.get('id') + "." + picture.type.match(/^(image\/)([a-z]+)/)[2]
    )


    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
        method: "POST",
        /* body: JSON.stringify(dataObject), */   // OVO DAKLE VISE NECU KORISTITI OVDE

        // U BODY-JU, TREBA DA BUDE         FormData        INSTANCA

        body: postData,

        /* headers: {                                // OVO HEADERS-I MI VISE NE TREBAJU
            "Content-Type": "application/json",      // JER NE SALJEM JSON STRING
            "Accept": "application/json"
        } */

        // STO SE TICE HEADERS-A, ONI POSTOJE ZA FormData

        //  "Content-Type": "application/x-www-form-urlencoded"        // ALI NECU KORISTITI

    })
    .then(resp => {
        console.log("Send Data: ", resp);
        // updateUI(dataObject)                // OVDE VIDIM GRESKU, JER UI UPDATE-UJEM PODACIMA, KOJIH VISE NEMA
                                         // REDEFINISACU OVO KASNIJE
        // PREDPOSTAVLJAM DA SE UI MOZE UPDAT-OVATI SA
        // PODACIMA OPET VRACENIM SA SERVERA, AKO JE REQUEST BIO USPESAN
    }) 

    // ALI UPAMTI DA JE OVAJ FALLBACK DEFINISAN OVAKO, A CLOUD FUNCTION NIJE REDEFINISANA DA RECEIVE-UJE FormData

    // ZATO OVO NECE FUNKCIONISATI, AKO BUDE POZVANO

    // REKAO SAM VEC RANIJE, ZASTO SAM OVO ~~~NAMERNO~~~~ UERADIO


};


const titleInput = document.querySelector('input#title');
const locationInput = document.querySelector('input#location');
const form = document.querySelector('div#create-post form');

form.addEventListener('submit', ev => {

    ev.preventDefault();


    if(titleInput.value.trim() === "" || locationInput.value.trim() === ""){
        alert("Please enter valid data!");

        return;
    }

    closeCreatingPostModal();   // RANIJE DEFINISANA FUNKCIJA U ISTOM FAJLU
                                // KADA SE SUBMITT-UJE FORMUALR, ODMAH SE SKALNJA MODAL NA KOJEM JE FORMULAR


    if('serviceWorker' in window.navigator && 'SyncManager' in window){    // AKO OVO NIJE ISPUNJENO, DOLE SE POZIVA
                                                                            // POMENUTI FALLBACK
        // OVDE CU POSLATI I SLIKU, ZAJEDNO SA OSTALIM PODACIMA

        navigator.serviceWorker.ready
        .then(swr => {
            
            // PODACI PUNE sync-posts OBJECT STORE, I TEK CE SE VADITI IZ SERVICE WORKER-A I TEK CE SE ONDA
            // NAKON INSTANTICIZIRANJA FormData INSTANCE, DEFINISATI KACENJE (TO JEST TO SAM VEC TAMO I DEFINISAO)
            // append METODOM, PODATKAK NA FormData INSTANCU, KOJA CE BITI POSLATA DO CLOUD FUNKCIJE (ENDPOINT-A)

            let post = {
                id: new Date().toISOString(),
                title: titleInput.value,
                location: locationInput.value,

                slika: picture    // DAKLE I blob INSATANCA SNAPSHOTA // (OVA INSTANCA JE RANIJE PROCITNAN SA CANVASA
                                  // KOJI JE CAPTURE-OVAO STREAM KAMERE)
                                  // BITI POSLATA U indexedDB
            }

                                // TO SAM URADIO ZBOG ONOG STO SAM VEC MNOGO PUTA OBJASNIO
                                // ALI RECI CU OPET
                                // ZELIM DA ISTATICIZIRAM       FormData    SA OVIM PODACIMA
                                // ALI U SERVICE WORKERU (ON sync HANDLER)

            writeData('sync-posts', post)

            .then(() => {
                
                // OVDE CU NAMERNO STAMPATI         picture
                // JER ZEIM DA SE POIGRAVAM, ODNOSNO DA ISPITUJEM POMENUTI Blob
                // U KONZOLI (MOGU DA GA NAINIM VREDNOSU temp VARIJABLE I TAK OSE POIGRAVAM)

                console.log("OVO JE BLOB SLIKE; IGRAJ SE S NJIM BLAH:", picture);

                return swr.sync.register('sync-new-post');
            })

            .then((syncRegistration) => {

                let snackbarContainer = document.querySelector('#confirmation-toast');
                let data = {message: "Your post was saved for synching!"};

                snackbarContainer.MaterialSnackbar.showSnackbar(data)

            })
            .catch(err => {
                console.log(
                    err, "STORING POST IN IndexedDb WAS UNSUCCESSFUL!, OR REGISTRATION OF SYNC TASK"
                );
            })

        })

    }else{

        sendData();         // KAO STO SAM REKAO POZIVA SE FALLBACK
    }

})
```

PRIKAZUJEM SAV BACKGROUND SYNC CODE SERVICE WORKERA, JER SE TAMO PODACI VADE IZ indexedDB-JA I PRAVI SE NETWORK REQUEST KA END POINT-U ('POST' REQUEST NARAVNO)

public/sw.js FAJL:

```javascript
self.addEventListener('sync', function(ev){

    console.log('--+---+-- SyncEvent --+---+--+---+-   ', ev);

    if(ev.tag === 'sync-new-post'){  // NARAVNO, AKO JE TRIGGER-OVAN sync EVENT, RELATED SA POMENUTOM REGISTRACIJOM
                                     // MOGU OVAJ STRING NAZVATI I REGISTRATION TAG-OM, TU JE DOSTUPAN, DA BIH ZNAO
                                     // STA DA VADIM IZ indexedDB-JA (SVE OBJASNJENO RANIJE)

        ev.waitUntil(                       // SERVICE WORKER DAKLE CEKA DOK SE SLEDECE NE IZVRSI (SVE OBJASNJENO VEC)

            readAllData('sync-posts')      // CITAM ONE PODATKE, KOJI SU POTREBNI ZA SLANJE SERVER-U (OBJASNJENO RANIJE)

            .then(dataArray => {            // DAKLE POSTOJI MOGUCNOST DA JE VISE OBJEKATA UBACENO U OBJECT STORE       'sync-posts'
                                            // A JA OVDE SALJEM POST REQUEST, ZA SVAKI POJEDINACNI OBJEKAT IZ OBJECT STORE-A
                                            // JER SAM ACCESS-OVAO SVIM OBJEKTIMA IZ OBJECT STORE-A

                for(let data of dataArray){


                    // REKAO SAM RANIJE DA CU OVDE INSTATICIZIRATI I FormData INSTANCU, ALI JE NECU SLATI SERVERU

                    const postData = new FormData();   // INSTANTICIZIRAO SAM GA (USTVARI BICE INSTATICIZIRAN U SVAKOJ ITERACIJI)
                                                       // ZA SVAKI EXTRACTED OBJECT IZ OBJECT STORE-A

                    // SADA IZ ODREDJENOG OBJEKTA (ODNOSNO OBJEKTA TRENUTNE ITERACIJE), KOJE JE OBJECT, OBJECT STORE-A  sync-posts
                    // EXTAHUJEM PODATKE

                    // FormData-I , PRVO APPEND-UJEM SVE PODATKE IZ TEKSTUALNIH INPUT-A (NARAVNO I id)

                    postData.append('id', data.id);
                    postData.append('title', data.title);
                    postData.append('location', data.location);

                    // A SADA APPEND-UJEM I Blob

                    // 1. ARGUMENT JE KLJUC, A KLJUC KOJI CE BITI NJEGOV (Blob-OV), U FORM DATA-U, NEKA SE ZOVE file, POSTO TAJ Blob REPREREZENTUJE FILE SLIKE
                    // A MOGA OSAM ZADATI BILO KOJI KLJUC (MEDJUTIM, POSTO SAM 'file' ZDAO I U FALLBACK-U, ONDA TO RADIM I OVDE (NE SME BITI RAZLIKE))

                    // 2. ARGUMENT, JESTE Blob INSTANCA naravno

                    // 3. ARGUMENT JE IME KOJE ZELIM DA IMA, FAJL, KOJI POMENUTI BLOB REPREZENTUJE

                                // NEKA TO IME BUDE FORMIRANO OD ONIH PODATKAK KOJE SU FORMIARALI id

                                // PLUS MIME TYPE FAJLA, KOJEG REPREZENTUJE Blob (OVO SE ODNOSI NA FORMAT SLIKE (jpg, jpeg, png..))

                    postData.append(
                        'file',

                        data.slika,          // ~~~~~~  U SVAKOM OBJEKTU, IZ, POMENUTOG OBJECT STORE-A,
                                             //         Blob     JE STORED KAO U PROPERTIJU slika ~~~~~~
                                             // TO SMA OBJASNIO (URADIO) GORE U on submit HANDLERU (feed.js FAJL)

                        postData.get('id') + "." + data.slika.type.match(/^(image\/)([a-z]+)/)[2]
                    )

                    // ~~~~~~~~~~~~~~~~~~~ DAKLE NECU GORNJI OBJEKAT (postData) SLATI NA SERVER,
                    // ~~~~~~~~~~~~~~~~~~~ ALI CU GA STAMPATI DA VIDIM OD CEGA SE SASTOJI
                    // ~~~~~~~~~~~~~~~~~~~ ODNOSNO PRIMENJIVACU METODE FormData-INOG PROTOTIPA NA NJEMU
                    // ~~~~~~~~~~~~~~~~~~~ GET-OVACU IZ NJEGA Blob   MOJE CAPTURED SLIKE (SNAPSHOT-A), UZ POMOC KLJUCA     file
                    // ~~~~~~~~~~~~~~~~~~~ PA CU NAD Blob INSTANCOM PRIMENJIVATI NEKE METODE

                                            // SVE CE TO BITI MOGUCE U CHROME KONZOLI, ZATO STO U CHROME KONZOLI
                                            // JA MOGU DESNIM CLICK-OM IZABRATI DA SE ZELENI ODSTAMPANI OBJEKAT
                                            // STORE-UJE U TRENUTNOJ VARIJABLI

                    //-----------------------------------------------------------
                            // DAKLE STAMPAM        FormData        INSTANCU
                    // console.log(postData);

                    //              

                    // STAMPACU GETTED      Blob        FROM FORM DATA
                    // console.log("-*-*-*-*-*-*-*", postData.get('file'), "-*-*-*-*-*-*-*-*-");

                    //-----------------------------------------------------------


                    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
                        method: "POST",
                        /* body: JSON.stringify({             // !!!! DAKLE OVO JE ONO STO CU MENJATI (ALI NE SADA, VEC TEK KAD DEFINISEM SERVER SIDE CODE)
                            id: data.id,                   // !!!! POSTO ZELIM DA PODATKE SALJEM KROZ FormData INSTANCA (DAKLE, ZELIM DA ONA BUDE U BODY-JU)
                            title: data.title,             // !!!! JA NE ZELIM STRINGIFIED OBJEKAT, KOJI JE SADA OVDE
                            location: data.location,       // !!!! ZAELI FormData INSTANCU, SA ONIM BLOB-OM, KAO SASTAVNIM DELOM

                                                           // ~~~~~~~  ALI JA CU OVO TEK MENJATI ONDA KADA BUDEM SREDIO SERVER SIDE CODE

                            image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'

                            // OVO JE BIO DUMMY IMAGE I ZATO JE OVO HARD CODED URL, KAKO GA NAZIVAJU
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        } */

                        body: postData
                    })
                    .then(resp => {
                        console.log("Send Data: ", resp);

                        if(resp.ok){

                            deleteItemFromData('sync-posts', data.id)     // KADA SU PODACI USPESNO POSLATI DO CLOUD FUNKCIJE,
                                                                          // ONI VISE NISU POTREBNI U indexedDB-JU  (OBJASNIO VEC RANIJE)
                        }


                    })
                    .catch(function(err){
                        console.log('Error, while sending data', err)
                    })

                }
            })
        );
    }
})
```

## :arrow_upper_right: MALO CU DA GOVORIM O MODULIMA os, fs I path, KOJE SAM UVEZAO U MOJ SERVER SIDE CODE

TI MODULI SU MODULI KOJI DOLAZE ZAJEDNO SA Node.js-OM

RECI CU NESTO O NJIMA I ZASTA CU IH UPOTREBLJAVATI U MOM PROJEKTU

:one: [os](https://nodejs.org/api/os.html#os_os) PAKET MOZE PRUZITI INFORMACIJE O OPERATIVNOM SISTEMU KORISNIKA (DA MOGUCE JE PRISTUPITI INFORMACIJAMA O OPERATIVNOM SISTEMU CLIENT-A, SA SERVER SIDE STRANE)

[ako ne verujes pogledaj ovaj primer](https://www.w3schools.com/nodejs/shownodejs_cmd.asp?filename=demo_ref_os)

MENI IZ OVOG PAKETA ZANIMA MOGUCNOST DA PRISTUPIM INFORMACIJAM TEMPORARY STORAGE-A OPERATIVNOG SISTEMA

**PREDPOSTAVLJAM DA KADA SE INSTATICIZIRA Blob INSTANCA, KONKRETAN FAJL KOJI ONA REPREZENTUJE NALAZI SE U TEMP STORAGE-U (TACNIJE TEMP DIREKTORIJUM) OPERATINOG SISTEMA, NA PRIMER WINDOWS**

E PA MOGU KORISTITI os PAKET, TACNIJE [os.tmpdir()](https://nodejs.org/api/os.html#os_os_tmpdir), KAKO BI PRISTUPIO TEMPORARY DIREKTORIJUMU, KORISNIKOVOG RACUNARA

ZAPAMTI DA SE TAMO NALAZI TVOJ FAJL

**AKO ZNAS IME FAJLA I AKO SI PRISTUPIO, POMENUTOM DIREKTORIJUMU, MOZES LAKO INICIRATI UPLOAD**

## SADA MOGU ODPOCETI SA DEFINISANJEM UPLOADING-A FAJLA I ZADAVANJA NJEGOVOG URL-A, DA BUDE DEO RELATED POST-A U REALTIME DATABASE-U

SASVIM JE JASNO IZ GORNJEG CODE DA ONO STA SE SALJE CLOUD FUNKCIJI JESTE FormData INSTANCA

SADA TREBAM UPOTREBITI busboy PAKET KAKO BI HANDLE-OVAO TAJ DATA, A POSEBNO Blob INSTANCU, KOJU SALJEM EMBEDED INSIDE FormData INSTANCE

MISLIM DA CU EKSPERIMENTISATI MALO I DA CU cors-OV CALLBACK ARGUMENT DEFINISATI TAKO DA BUDE async FUNCTION; DAKLE U VELIKOJ MERI ZELI MDA KORISTIM await

```javascript

```


```javascript
// UVOZIM POMENUTA DVA PAKETA


/* const functions = require('firebase-functions');

const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});

const serviceAccount = require("./instaclone-fb-key.json");

const webpush = require('web-push');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {
	  
	cors(request, response, function () {
    	admin.database().ref('posts').push({
      		id: request.body.id,
      		title: request.body.title,
      		location: request.body.location,
      		image: request.body.image
    	})
		.then(function () {
			webpush.setVapidDetails(
				"mailto:bajic.rade2@gmail.com",
				publicVapidKey,
				privateVapidKey
			);
			return admin.database().ref('subscriptions').once('value');
		})
		.then(function (subscriptions) {
			subscriptions.forEach(function (sub) {
				var pushConfig = {
					endpoint: sub.val().endpoint,
					keys: {
						auth: sub.val().keys.auth,
						p256dh: sub.val().keys.p256dh
					}
				};

				webpush.sendNotification(
					pushConfig,
					JSON.stringify({
                        title: 'New Post',
                        content: 'New Post added!',

                        // DAKLE OVAJ OBJEKAT CE JOS IMATI I       openUrl    PROPERTI
                        // ZADACU RELATIVNI PATH ZA help/index.html PAGE, KOJ JE HOSTED NA ISTOM SERVERU

                        openUrl: '/help'    // NIJE POTREBNO NAVODITI I index.html JER TO JE ONO
                                            // STO SE PO DEFAULTU MORA OTVORITI NA PATH-U
                    })
                )
				.catch(function(err) {
					console.log(err);
				})

			});
			
			return response.status(201).json({message: 'Data stored', id: request.body.id});
		})
		.catch(function (err) {
			response.status(500).json({error: err});
		});
  
	});
}); */






















/* 
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);  // OVO JE POGRESNO KORISCENJE PAKETE
                                                         // ILI JE OUTDATED
                                                         // ZBOG POMENUTE STVARI, NECE BITI MOGUC NI DEPLOYMENT
const file_system = require('fs');

const UUID = require('uuid-v4');


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6BtrF6z7_p7Je3jarU6rVY";
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkIgcDWDRgFzvrBCChNxX_spJoSM";



// ******************************************************


admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.IncomingForm();   // OBRATI PANJU DA JE OVDE I KARAKTER NAPISAN VELIKIM

        const uuid = UUID();

        formData.parse(request, function(error, fields, files){             // PITANJE JE I DA LI SAM PRAVILNO KORISTIO formidable PAKET

            if(!error){

                admin.database().ref('posts').push({

                    id: fields.id,
                    title: fields.title,
                    location: fields.location,


                    image: 'https://firebasestorage.googleapis.com/v0/b/' + bucket.name + '/o/' +
                            file.name + '?alt=media&token=' + uuid

                })
                .then(function () {
                    webpush.setVapidDetails(
                        "mailto:bajic.rade2@gmail.com",
                        publicVapidKey,
                        privateVapidKey
                    );
                    return admin.database().ref('subscriptions').once('value');
                })
                .then(function (subscriptions) {
                    subscriptions.forEach(function (sub) {
                        var pushConfig = {
                            endpoint: sub.val().endpoint,
                            keys: {
                                auth: sub.val().keys.auth,
                                p256dh: sub.val().keys.p256dh
                            }
                        };

                        webpush.sendNotification(
                            pushConfig,
                            JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                        ))
                        .catch(function(err) {
                            console.log(err);
                        })

                    });

                    return response.status(201).json({message: 'Data stored', id: fields.id});
                })
                .catch(function (err) {
                    response.status(500).json({error: err});
                });

            }else{
                console.log(error)
            }


        })

    });
}); */





```