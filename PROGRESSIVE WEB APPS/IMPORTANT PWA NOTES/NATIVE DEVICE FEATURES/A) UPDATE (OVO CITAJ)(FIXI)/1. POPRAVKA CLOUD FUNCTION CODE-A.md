# OVDE CU DAKLE POPRAVITI CODE MOJE CLOUD FUNKCIJE, KOJA JE TREBALA DA RECEIVE-UJE FORM DATA; A PROBLEMI SU NASTALI ZBOG KORISCENJA PAKETA formidable; ON SE NAIME VISE NE MOZE KORISTITI, JER JE FIREBASE PRETRPEO NEKE PROMENE, O KOJIM CU GOVORITI TEK NA KRAJU OVOG FAJLA

PRE SVEGA JA CU OVDE OSTAVITI NEKE VALIDNE INFORMACIJE, KOJE SE TICU, KORISCENJA STORAGE-A

ALI OBRATICU PAZNJU I NA NEKE PROMENE, KOJE SU SE DESILE U FIREBASE-U

## MISLI MDA SAM JA U OVOM PROJEKTU KORISTIO FIREBASE NA STARI NACIN, A ONO STO NISAM URADIO JESTE INICIJALIZACIJA FIREBASE APP-A DIREKTNO U MOM PROJEKTU, CIME 'POVEZUJEM' MOJ APP SA FIREBASE-OM; STO MI OMOGUCAVA LAKSE KORISCENJE FIREBASE FEATURE-A U MOM APP, I LAKSE HANDLE-OVANJE NETWORK REQUEST-OVA U CLOUD FUNKCIJAMA, KOJE STIZU IZ MOG APP

KADA REGISTRUJEM MOJ APP KAO FIREBASE APP, NA PLATFORMI TO MI OLAKSAVA POSAO, JER SE NE MORAM BAVITI DODATNIM PROBLEMIMA

TO JE NAIME 'TWO WAY STREET' STO SE TICE CLOUD FUNKCIJA

IDEM U FIREBASE KONZOLU I BIRAM SETTING-SE (MALI ZUPCANIK)

ODATLE MOGU REGISTROVATI MOJ APP KAO FIREBASE WEB APLIKACIJU (MOGUCE SU OPCIJE I ZA NATIVE APP ITD)

U SUSTINI SVE MI JE PROVIDED

A TO STO JE PROVIDED POTREBNO JE EMBED-OVATI U MOJ PAGE

DAKLE KOPIRAM SLEDECE STVARI U MOJ PAGE, PRI DNU body ELEMENTA, PRE NEGO SE U BILO KOJIM SCRIPT-OVIMA MOJE APLIKACIJE, BUDE KOORISTIO FIREBASE

```HTML
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>

<!-- KADA MOJ APP CODE-IRAM UZ POMOC BUNDLER-A KAO STO JE WEBPACK, JASNO JE DA 
CU PREDHODNI SCRIPT UVOZITI KAO MODUL, ALI TO SAM OBJASNIO VEC U DRUGOM PROJEKTU
ZNAS VEC KOJEM -->

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#config-web-app -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {                                // OVDE SU BILE INFORMCIJE
                                                        // ALI NECU IH PRIKAZATI
                                                        // IAKO TO NISTA I NE ZNACI
                                                        // SMEJU DA BUDU PUBLIC

                                                        // ALI IPAK NAJBOLJE JE KADA KORISTIM NEKI 
                                                        // BUILD SISTEM KAO STO JE WEBPACK
                                                        // DA OVU KONFIGURACIJU UVEZEM KAO JSON
    apiKey: "AIzaSyB76KSNqmgZIJrzSd9QQis-ls",
    authDomain: "instapwBLAH.firebap.com",
    databaseURL: "https://instaBLAHne.firebaseio.com",
    projectId: "insta-pwa-clone",
    storageBucket: "insta-pwa-clone.appspot.com",
    messagingSenderId: "693903166",
    appId: "1:69379966:web:733c23ca6bdba"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>

<!-- OVDE SU MOJI OSTAL ISCRIPT-OVI IZ MOG PROJEKTA, A NEKI OD NJIH KORISTE FIREBASE -->
<!-- USTVARI SAMO SALJU REQUEST-OVE DO ENDPOINTA, ODNOSNO DO CLOUD FUNKCIJA -->

<script src="/src/js/material.min.js"></script>
<script src="/src/js/idb.js"></script>
<script src="/src/js/utility.js"></script>
<script src="/src/js/feed.js"></script>
<script src="/src/js/app.js"></script>

<!-- KRAJ body TAGA -->

```

## SADA ONO STO BI TREBALO DA BUDE LAKSE NA STRANI CLOUD FUNKCIJA, JESTE LAKSE HANDLE-OVANJE NEKIH REQUEST-OVA, KONKRETNO MISLIM DA NE MORAM KORISTITI @google-cloud/storage PAKET

NAIME DA NISAM UVEZAO GORNJU KONFIGURACIJU, MORAO BI NA PRIMER U CLOUD FUNKCI DEFINISATI CONFIG FAJL, DIREKTNO NAMENJEN TOM PAKETU

**MORAO BI KORISTITI NEKE DOWNLOAD TOKENE**

E PA TO SE SADA OBAVLJA IZA KULISA (KORISCENJEM POMENUTIH config INFORMACIJA) (MISLIM DA SAM TO NAPOMENUO I U DRUGOM PROJEKTU)

**NARAVNO POTREBNO JE INICJALIZOVATI APP I U functions/index.js FAJLU, ALI TO JE ZNATNO JEDNOSTAVNIJE** (USTVARI UPRAVO CE OVO RESITI PROBLEM TOKENA KOJI SE SALJU U SLUCAJU STORAGE-A)

I NECU MORATI KORISTITI POMENUTI GOOGLE STORAGE PAKET

## POCECU OD POCETKA, NAIME REDEFINISACU CEO functions/index.js FAJL, JER ZELIM DA UVEZEM TACNO ONE STVARI, KOJE CU KORISTITI, ZATIM CU SVE DEFINISATI I U SKLADU SA MODERNOM SINTAKSOM

>>> KADA DEPLOY-UJEM FUNKCIJE A NE KORISTIM MODERNU SINTAKSU, FIREBASE MI POKAZUJE WARNING-E
>>> PROVERI TAKODJE DA LI JE Node.js 8 U UPOTREBI ZA TVOJ PROJEKAT
>>> AKO NIJE UPDATE-UJ, ONAKO KAKO SAM TO POKAZAO U DRUGOM PROJEKTU

**MEDJUTIM HAJDE DA PRVO URADIM INSTALIRANJE I UPDAT-OVANJE PAKETA** (OVO MOGU RADITI U MOM package.json FAJLU) (NE ZNA MDA LI JE OVO ZATO STO SE ONI KORISTE NA CLIENT-U (NE SECAM SE DA LI SE KORTISTE NA CLIENT STRAN IAL ICU SAZNATI KASNIJE))

**NEKA URADICU TO I U MOM functions/package.json FAJLU, ALI I ONOM functions/package.json**

TAKODJE OVE PAKETE BI TREBAL ODA IMAM GLOBALNO (NE ZNAM ZASTO, ALI ZA SADA IH NECU INSTALIRATI GLOBALNO JER IH VEC IMAM), A UVEK ZELI MDA IH INSTALIRAM NA LATEST VERZIJU

DAKLE INSTALIRAM IH LOKALNO (MISLIM DA IH MOGU INSTALIRATI SAMO U package.json FAJLU)

ALI INSTALIRACU IH I U functions.package.json ,JER SU OD RANIJE TAMO INSTALIRANI, A JA ZELIM LATEST VERZIJU

- npm install firebase-functions@latest firebase-admin@latest --save

(ALI IPAK MISLIM DA SU POTRENE INSTALACIJE NA DVA MESTA, AKO ZELIM DA KORISTIM TE PAKETE LOKALNO ALI I ZA CLOUD-U (FUNCTIONS))

**TAKODJE CU U functions INSTALIRATI I [busboy](https://www.npmjs.com/package/busboy) PAKET**

- npm install --save busboy

**formidable MOZES UKLONITI**

- npm uninstall formidable --save

SADA DA KONACNO POCNEM SA REDEFINISANJEM

functions/index.js FAJL:

```javascript
// UVOZIM POMENUTA DVA PAKETA


/* const functions = require('firebase-functions');

const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});

const serviceAccount = require("./instaclone-fb-key.json");

const webpush = require('web-push');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {
	  
	cors(request, response, function () {
    	admin.database().ref('posts').push({
      		id: request.body.id,
      		title: request.body.title,
      		location: request.body.location,
      		image: request.body.image
    	})
		.then(function () {
			webpush.setVapidDetails(
				"mailto:bajic.rade2@gmail.com",
				publicVapidKey,
				privateVapidKey
			);
			return admin.database().ref('subscriptions').once('value');
		})
		.then(function (subscriptions) {
			subscriptions.forEach(function (sub) {
				var pushConfig = {
					endpoint: sub.val().endpoint,
					keys: {
						auth: sub.val().keys.auth,
						p256dh: sub.val().keys.p256dh
					}
				};

				webpush.sendNotification(
					pushConfig,
					JSON.stringify({
                        title: 'New Post',
                        content: 'New Post added!',

                        // DAKLE OVAJ OBJEKAT CE JOS IMATI I       openUrl    PROPERTI
                        // ZADACU RELATIVNI PATH ZA help/index.html PAGE, KOJ JE HOSTED NA ISTOM SERVERU

                        openUrl: '/help'    // NIJE POTREBNO NAVODITI I index.html JER TO JE ONO
                                            // STO SE PO DEFAULTU MORA OTVORITI NA PATH-U
                    })
                )
				.catch(function(err) {
					console.log(err);
				})

			});
			
			return response.status(201).json({message: 'Data stored', id: request.body.id});
		})
		.catch(function (err) {
			response.status(500).json({error: err});
		});
  
	});
}); */






















/* 
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);  // OVO JE POGRESNO KORISCENJE PAKETE
                                                         // ILI JE OUTDATED
                                                         // ZBOG POMENUTE STVARI, NECE BITI MOGUC NI DEPLOYMENT
const file_system = require('fs');

const UUID = require('uuid-v4');


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6BtrF6z7_p7Je3jarU6rVY";
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkIgcDWDRgFzvrBCChNxX_spJoSM";



// ******************************************************


admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.IncomingForm();   // OBRATI PANJU DA JE OVDE I KARAKTER NAPISAN VELIKIM

        const uuid = UUID();

        formData.parse(request, function(error, fields, files){             // PITANJE JE I DA LI SAM PRAVILNO KORISTIO formidable PAKET

            if(!error){

                admin.database().ref('posts').push({

                    id: fields.id,
                    title: fields.title,
                    location: fields.location,


                    image: 'https://firebasestorage.googleapis.com/v0/b/' + bucket.name + '/o/' +
                            file.name + '?alt=media&token=' + uuid

                })
                .then(function () {
                    webpush.setVapidDetails(
                        "mailto:bajic.rade2@gmail.com",
                        publicVapidKey,
                        privateVapidKey
                    );
                    return admin.database().ref('subscriptions').once('value');
                })
                .then(function (subscriptions) {
                    subscriptions.forEach(function (sub) {
                        var pushConfig = {
                            endpoint: sub.val().endpoint,
                            keys: {
                                auth: sub.val().keys.auth,
                                p256dh: sub.val().keys.p256dh
                            }
                        };

                        webpush.sendNotification(
                            pushConfig,
                            JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                        ))
                        .catch(function(err) {
                            console.log(err);
                        })

                    });

                    return response.status(201).json({message: 'Data stored', id: fields.id});
                })
                .catch(function (err) {
                    response.status(500).json({error: err});
                });

            }else{
                console.log(error)
            }


        })

    });
}); */





```