# What do you need to do?**

**Replace the content** of your `functions/index.js`  file with the
content of the file attached to this and the last lecture (pick either
of the two, they contain the same content).

Replace `YOUR_PROJECT_ID`  with, well, your Firebase project id. Also
make sure to replace the VAPID details in the code with the ones
generated by you.

Run

- `npm install --save busboy`  **inside the** `functions

folder (i.e. `cd functions`  first).

You can now also uninstall formidable
(`npm uninstall --save formidable`).

Additionally, edit your `package.json` file (in the functions
folder) like this:

``` {.prettyprint .linenums}
"@google-cloud/storage": "WHATEVER VERSION YOU HAVE HERE",
```

should become

``` {.prettyprint .linenums}
"@google-cloud/storage": "1.7.0",
```

Thereafter, re-run `npm install` .

**OR**

You simply install that version of `@google-cloud/storage` right from
the start

- `npm install --save @google-cloud/storage@1.7`

That's it!

**Why?**

Firebase cloud functions received a **breaking change** that impacts how
we parse request data. Therefore, Formidable doesn't work anymore.

See the following thread for more
infos: [https://stackoverflow.com/questions/47242340/how-to-upload-a-file-using-express-on-firebase-cloud-functions](https://stackoverflow.com/questions/47242340/how-to-upload-a-file-using-express-on-firebase-cloud-functions)

We'll use the workaround explained there. Attached to the last and this
lecture, you find the updated function code -**no changes to other
files** (e.g. service worker etc.) are required!

**What changed in the cloud function code?**

Firebase parses the request body for us and turns it into a Buffer
(that's what changed - previously, it didn't parse it for us).

Hence we now use a different library - `busboy`  - to read the data from
that Buffer. All the other code (e.g. upload file to bucket, store data
in database) still is the same as shown in the video.
