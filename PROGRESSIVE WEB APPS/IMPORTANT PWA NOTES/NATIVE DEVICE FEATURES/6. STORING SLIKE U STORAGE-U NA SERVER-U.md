# STAVLJANJE SLIKE U STORAGE NA SERVER-U

:collision: :anger: :collision: :anger::collision: :anger: :collision: :anger: :collision: :anger:

**ODMAH DA KAZEM DA CODE SERVER STRANE NIJE RADIO, ZBOG JEDNOG PAKETA**

- MISLIM DA JE **@google-cloud/storage** PAKET BIO PROBLEMATICAN

**MISLIM DA JE TO IZ RAZLOGA STO SAM KORISTIO OUTDATED SINTAKSU, KOJA NIJE PODRZAVALA NI Promise-E**

>>>> TAKODJE, MOZDA NIJE DOBRO UPOTREBLJEN Blob, KOJI SE SALJE NA SERVER

>>>> ODNOSNO, MOZDA FormData INSTANCA NIJE DOBRO FORMIRANA

:collision: :anger::collision: :anger::collision: :anger::collision: :anger::collision: :anger::collision:

## NEKA UVODNA RAZMATRANJA, KOJA SU VAZNA, PRVENSTVENO JER OBJASNJAVAJU Blob

DA NESTO RAZJASNIM PRE ONOGA STO JE TEMA OVE LEKCIJE

**KADA GOVORIM O Blob-U, U PITANJU JE FAJL (ILI REPREZENTACIJA ACTUAL FILE-A), KOJI SE MORA TRANSFORMISATI U objectUrl (DOM String KOJI SADRZI URL) DA BIH IMAO VALIDNU VREDNOST ZA DODAVANJE src ATRIBUTU NEKE SLIKE ,ODNOSNO TREBA MI URL KAK OBIH MOGAO REFERENCIRATI SOURCE OBJECT, ODNOSNO FAJL, KOJI REPREZENTUJE Blob INSTANCA**

ILI JOS BOLJE POGLEDAJ OVAJ CITATI, KOJI OBJASNJAVA, STA JE Blob USTVARI

> A blob object represents a chuck of bytes that holds data of a file. But a blob is not a reference to a actual file, it may seem like it is.

> A blob has its size and MIME type just like a file has. Blob data is stored in the memory or filesystem depending on the browser and blob size. A blob can be used like a file wherever we use files.

**DAKLE Blob JE REPREZENTACIJA NEKOG FAJLA, KOJI SE ZAISTA NALAZI U FILE SYSTEM-U BROWSERA ILI NECEG DRUGOG; A KAKO BI CEO FAJL BIO TRANSFORMISAN I KORISCEN U JAVASCRIPT-U, U PUNOSJ SVOJOJ TEZXINI U BUTE-IME, ON SE MORA TRANSFORMISTAI U BASE64 STRING**

**KADA IMAM BASE64 URI VREDNOST, TO JE STRING VREDNOST, KOJA MORA BITI TRANSFERED U Blob, KAKO BI SE MOGLA KORISTITI, DALJE KAKO SAM POMENUO**

> DA SADA NASTAVIM

IMAGE, KOJI IMAM, KADA PRITISNEM CAPTURE, ZIVI SAMO U canvas ELEMENT-U

**JA MOGU UZETI BASE64 FORMAT TE SLIKE OD CANVASA**

NE BIH SMEO DA STORE-UJEM OVAJ BASE64 U DATABASEU, ODNOSNO TAJ NJEN BASE64 URI, JER JE TO OGROMAN STRING

MORAM GA PRETVORITI U Blob INSTANCU (U SUSTIN ITREBA MI FAJL), KOJI CU ONDA STORE-OVATI U STORAGE-U NA FIREBASE-U, ODNOSNO UPLOAD-OVACU GA TAMO

## JA SAM RANIJE KORISTITO URL.createObjectURL(), SA Blob-OM KAO ARGUMENTOM KAKO BIH KREIRAO VALIDAN DOM STRING KOJI MOGU DODELITI src ATRIBUTU (CISTO SE PODSECAM)

- TADA JA REQUEST-UJEM SLIKU (ODNOSNO NJEN LINK) IZ NEKOG STORAGE-A (IMAJ NA UMU DA NE GOVORIM O DATABASE-U (U DATABASE-U NIKAD DAKLE NE STAVLJAM BASE64 VREDNOST))

- TADA U Body MIXIN-U, KOJI JE DEO Response-A, JA DOBIJAM STRING U JSON FORMATU, KOJI ONDA MOGU PRETVORITI U Blob INSTANCU, KADA NAD Response-OM PRIMENIM METODU, NJEGOVOG Body MIXIN-A

- DA, MISLIO SAM NA blob() METODU

- POMENUTA Blob INSTANCA ODNOSNO BINARY LARGE OBJECT MORA SE PRETVORITI U DO MSTRING, ODNOSNO URL, KOJI JE PREFIXED SA "data:" , I TAKAV JE VALIDNA VREDNOST src ATRIBUTA NEKOG img ELEMENTA, ILI url FUNKCIJE U CSS-U

## AKO SE PODSETIS: file-loader I url-loader; BICE TI MOZDA BRZE JASNIJE OVO

U SUSTINI JA SAM TADA KORISTIO url-loader, KAKO BI TRANSFORMISAO-OVAO DATA, KAKO BI DIREKTNO MOGAO KORISTITI BASE64 U SLUCAJU KADA JE TAJ BASE64 STRING BIO MANJI (DEFINISANJE LIMITA), I TADA BIH SLIKU DIREKTNO KORISTIO U JAVASCRIPTU, BEZ POSTOJANJA FILE U BUILD FOLDERU

DAKLE NA TAJ NACIN SLIKA JE BILA REPRESENTED U BASE64 DATA FORMATU DIREKTNO U JAVASCRIPT-U

I TAKO JE SLIAK STIZALA SA SERVERA ZAJEDNO SA JAVASCRIPT FAJLOM (DAKLE SAMO JEDAN NETWORK REQUEST)

A file-loader JE BIO ODGOVORAN ZA TO DA NA RESOLVE-UJE import()/require() NA FILE-U INTO URL

## ALI STA, KADA ZELIM DA OD Data URI-A (BASE64 VREDNOSTI), PROCITANOG OD CANVAS-A, NAPRAVIM Blob INSTANCU, KOJU TREBA DA POST-UJEM NA DATABASE, KAO DEO Body-JA NEKOG Request-A

MORAM KORISTITI METODU, KOJA BASE64, ODNOSNO Data URI TRANSFORMISE U Blob INSTANCU

ZA TO CU KORISTITI, JEDNU FUNKCIJU, PREKOPIRANU, KOJU CU PROSLEDITI U utility.js FAJL

**utility.js** FAJL, KOJI SE PRVI UCITAVA U MOJ HTML, I CIJE FUNKCIJE KORISTE SLEDECI FAJLOVI:

```javascript
// DEFINISAO SAM JE NA SAMOM DNU FAJLA, POSLE OSTALIH METODA DODATIH RANIJE

function dataURItoBlob(dataURI) {
  var byteString = atob(dataURI.split(',')[1]);
  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
  var ab = new ArrayBuffer(byteString.length);
  var ia = new Uint8Array(ab);
  for (var i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }
  var blob = new Blob([ab], {type: mimeString});
  return blob;
}
```

## POTREBNO JE DA KREIRAM JEDNU GLOBALNU VARIJABLU, KOJOJ CU DODELITI Blob INSTANCU KAO VREDNOST, NARAVNO, NAKO NSTO KREIRAM TAJ Blob, ITAJUCI BASE64 VREDNSOT SLIK-E IZ canvas-A I TRANSFORMISUCI JE UZ POMOC GORNJE FUNKCIJE U Blob INSTANCU

TO MOGU URADITI U OBIMU HANDLER-A, KOJI JE onclick HANDLER, ZAKACEN NA CAPTURE DUGME

U TOM HANDLERU, JA SAM ONAJ MEDIA STREAM, IZ KAMERE INSERTED U video ELEMENT; USTVARI CAPTURE-OVAO, I STAVLJAO JEDAN SNAPSHOT U canvas ELEMENT

E PA TADA JA MOGU IZ CANVASA IZVUCI TAJ BASE64 VALUE SNAPSHOT-A, I PRETVORITI GA U BLOB, I DODELITI GA VARIJABLOJ

feed.js

```javascript
const videoPlayer = document.querySelector('video#player');
const canvasElement = document.querySelector('canvas#canvas');

const captureButton = document.querySelector('button#capture-btn');


const imagePicker = document.querySelector('input#image-picker');
const imagePickerArea = document.querySelector('div#pick-image');

//  DEKLARISACU OVDE VARIJABLU, KOJA CE SKALDISTITI blob INSTANCU, KOJU CU
//  DODELITI TEK DOLE U onclick HANDLER-U, ZAKACENOM NA CAPTURE DUGME

let picture;

const initializeMedia = function(){

    if(!('mediaDevices' in window.navigator)){

        window.navigator.mediaDevices = {};

    }

    if(!('getUserMedia' in window.navigator.mediaDevices)){

        window.navigator.mediaDevices.getUserMedia = function(constraints){

            let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

            if(!getUserMedia){

                return Promise.reject(new Error('getUserMedia is not implemented'));

            }

            return new Promise((resolve, reject) => {

                getUserMedia.call(
                    window.navigator,
                    constraints,
                    resolve,
                    reject
                );

            })

        }

    }


    window.navigator.mediaDevices.getUserMedia({video: true})

    .then(mediaStream => {

        videoPlayer.srcObject = mediaStream;

        videoPlayer.style.display = "block";
    })

    .catch(err => {

        imagePickerArea.style.display = "block";
        captureButton.style.display = "none";

    })


};

// ********************************************************
// ********************************************************

captureButton.addEventListener('click', ev => {

    canvasElement.style.display = "block";

    videoPlayer.style.display = "none";

    captureButton.style.display = "none";

    let context = canvasElement.getContext('2d');

    context.drawImage(
        videoPlayer,
        0,
        0,
        canvasElement.width,
        canvasElement.width / (videoPlayer.videoWidth /  videoPlayer.videoHeight)
    );

    videoPlayer.srcObject.getVideoTracks().forEach(track => {
        track.stop();
    })

    // CITAM BASE64 VREDNOST SA canvas-A, TAK OSTO NA NJMU PRIMENIM METODU toDataURL()
    // ZATIM, TU VREDNOST, PROSLEDJUJEM U UTILITY METODU    dataURItoBlob
    // IZ TOGA CE PROIZICI Blob INSTANCA

    picture = dataURItoBlob(canvasElement.toDataURL());

    // MOGU SADA DA REDEFINISEM POST REQUEST, PO KOJEM SE PRVO STAVLJA
    // OVA SLIKA U STORAGE

    // ALI I NJEN URL SA TO STORAGE-A, TREBA DA BUDE ONO STO CE BITI U
    // JEDNOM OBJECT-U DATABASE, SA OSTALIM PODACIMA POST-A

})

// ********************************************************
// ********************************************************

const buttonOther = document.querySelector('.plusButtonOther');

const openCreatingPostModal = ev => {

    initializeMedia();

    const elem = document.querySelector('div#create-post');
    elem.classList.remove('closeP');
    elem.classList.add('openP');
};

const closeCreatingPostModal = ev => {
    const elem = document.querySelector('div#create-post');

    elem.classList.remove('openP');
    elem.classList.add('closeP');

    videoPlayer.style.display = "none";
    imagePickerArea.style.display = "none";

}

buttonOther.addEventListener('click', openCreatingPostModal)

buttonClose.addEventListener('click', closeCreatingPostModal);
```

## :exclamation::exclamation::exclamation: MEDJUTIM SAZNAO SAM DA canvas IMA METODU: toBlob()    :question::question::question:

PITAM SE DA LISAM MOGAO KORISTITI [POMENUTU METODU](https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob) canvas-A, ZA DOBIJANJE Blob-A, MOJE CAPTURED SLIKE

> ISPITACU OVO JEDNO MPRILIKOM, ZA SADA KORISTIM UTITLIYP METODU, KOJU SAM OBEZBEDIO U utility.js FAJLU

## NAIME JA BIH SADA ZELEO DA UPLOAD-UJEM IMAGE, ODNOSNO ONU Blob INSTANCU, KOJU REFERENCITA picture VARIJABLA; ALI KAKO TO URADITI

KAKO UPLOAD-OVATI SLIKU NA MOJ SERVER?

JA VRSIM INTERAKCIJU SA MOJIM SERVER-OM, UGLAVNOM PUTEM SERVICE WORKER-A

TAMO KORISTIM BACKGROUND SYNCHRONIZATION

sw.js (BACKGROUND SYNC DEO, KOJI SAM DEFINISAO KADA SAM SE BAVIO BACKGROUND SYNCHRONIZATIONOM)

```javascript
self.addEventListener('sync', function(ev){

    if(ev.tag === 'sync-new-post'){  

        ev.waitUntil(
            /*samo na pominjem da je sledeca metoda uvezena iz utility.js*/
            readAllData('sync-posts')

            .then(dataArray => {

                for(let data of dataArray){

                    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
                        method: "POST",
                        body: JSON.stringify({
                            id: data.id,
                            title: data.title,
                            location: data.location,

                          // OVDE SAM RANIJE DEFINISAO DA SE SALJE
                          // DUMMY PICTURE; CISTO NAPOMINJEM
                            image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        }
                    })
                    .then(resp => {
                        console.log("Send Data: ", resp);

                        if(resp.ok){
                            /*samo na pominjem da je sledeca metoda uvezena iz utility.js*/
                            deleteItemFromData('sync-posts', data.id)

                        }

                    })
                    .catch(function(err){
                        console.log('Error, while sending data', err)
                    })

                }
            })
        );
    }
})
```

**JA USTVARI SALJEM MOJE JSON PODATKE DO CLOUD FUNCTION-A, DAKLE FUNCTION-A NA SERVERU, I TAJ FUNCTION, ONDA VRSI STORING DATA U DATABASE** (TO BI TREBALO DA MI BUDE JASNO)

PRIKAZACI JOS JEDNOM, POMENUTU CLOUD FUNKCIJU

functions/*index.js* FAJL:

```javascript
const functions = require('firebase-functions');

const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});


const serviceAccount = require("./instaclone-fb-key.json");


const webpush = require('web-push');


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6BtrF6z";  // lazni kljucevi zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkIgcDW";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {
	  
	cors(request, response, function () {
    	admin.database().ref('posts').push({
      		id: request.body.id,
      		title: request.body.title,
      		location: request.body.location,
      		image: request.body.image
    	})
		.then(function () {
			webpush.setVapidDetails(
				"mailto:bajic.rade2@gmail.com",
				publicVapidKey,
				privateVapidKey
			);
			return admin.database().ref('subscriptions').once('value');
		})
		.then(function (subscriptions) {
			subscriptions.forEach(function (sub) {
				var pushConfig = {
					endpoint: sub.val().endpoint,
					keys: {
						auth: sub.val().keys.auth,
						p256dh: sub.val().keys.p256dh
					}
				};

				webpush.sendNotification(
					pushConfig, 
					JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
				))
				.catch(function(err) {
					console.log(err);
				})

			});
			
			return response.status(201).json({message: 'Data stored', id: request.body.id});
		})
		.catch(function (err) {
			response.status(500).json({error: err});
		});
  
	});
});
```

## JA BI SADA TREBALO DA REDEFINISEM, POMENUTI CLOUD FUNCTION, KAKO ONA VISE NE BI ACCEPT-OVALA JSON PODATKE, VEC FORM DATA

TO JE ZATO STO FORM DATA MENI DOZVOLJAVA DA MIX-UJEM NORMALNE KEY-VALUE PAROVE SA FAJLOVIMA

TAMO GDE SAM DEFINISAO STRING URL-A, ZA IMAGE; TO VISE NE BI TREBAL ODA BUDE STRING WHEN RECEIVEING DATA, TO BI SADA TREBALO DA BUDE REAL FILE

DAKLE TREBAM DA BUDEM U MOGUCNOSTI DA POSALJEM RAZLICIT FORMAT

## ALI I ONI PODACI, KOJI SE SALJU, ODNOSNO TAMO SVUGDE GDE SAM DEFINISAO POST REQUEST, JA USTVARI TREBAM DA KORISTIM FormData INTERFEJS

[GOVORIO SAM OVDE O NJEMU](https://github.com/Rade58/apis_trying_out_and_practicing/blob/master/PROGRESSIVE%20WEB%20APPS/IMPORTANT%20PWA%20NOTES/fetch%20API%20%28PODSECANJE%20I%20DODATNA%20ZAPAZANJA%29/4.%20'POST'%20REQUEST.md#formdata-interfejs)

DAKLE, I U SERVICE WORKER-U, ALI I U fedd.js , ODNOSNO FAJLU, KOJI JE CONNECTED SA DOM-OM I U KOJEM SAM DEFINISAO POST REQUEST, KAO FALLBACK, KADA BROWSER NE PODRZVA BACKGROUND SYNC, ODNOSNO NE PODRZAVA SERVICE WORKER-E JA MORAM DEFINISATI POST REQUESTM, UZ POMOC FormData INTERFACE-A

## DAKLE, TREBAM MENJATI SLEDECE

ODNOSNO POTREBNO JE IMPLEMENTIRATI FormData INTERFACE NA SLEDECIM MESRIMA U SLEDECIM FAJLOVIMA

src/js/**feed.js** FAJL:

```javascript

// OVO JE FALLBACK FUNKCIJA

function sendData(){

    const dataObject = {
        id: new Date().toISOString(),
        title: titleInput.value,
        location: locationInput.value,
        image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
    }

    // DAKLE KADA SAM DEFINISAO body Request-A JA SAM MU ZADAO JSON STRING KAO VREDNOST
    // TO BI TREBALO DA ZAMENIM SA       FormData

    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
        method: "POST",
        body: JSON.stringify(dataObject),
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
        }
    })
    .then(resp => {
        console.log("Send Data: ", resp);
        updateUI(dataObject)
    })
}

// I OVA POMENUTA FALLABCK FUNKCIJA
// JE ISKORISCENA, ONDA KADA NE POSTOJI ServiceWorker ILI SyncManager

// DAKLE, DEFINISAO SAMTAKO
// DA CE U onsubmit HANDLER-U, POMENUTA FUNKCIJA BITI POZVANA KADA POMENUTE STVARI NISU PODRZANE

const titleInput = document.querySelector('input#title');
const locationInput = document.querySelector('input#location');
const form = document.querySelector('div#create-post form');

form.addEventListener('submit', ev => {

    ev.preventDefault();


    if(titleInput.value.trim() === "" || locationInput.value.trim() === ""){
        alert("Please enter valid data!");

        return;
    }
    closeCreatingPostModal();


    if('serviceWorker' in window.navigator && 'SyncManager' in window){

        navigator.serviceWorker.ready
        .then(swr => {

            // DA SE SAMO PODSETIM DA SE OVDE PODACI SALJU INDEKSIRANOJ BAZI PODATAKA BROWSER-A

            let post = {
                id: new Date().toISOString(),
                title: titleInput.value,
                location: locationInput.value
            }


            writeData('sync-posts', post)
            .then(() => {
                swr.sync.register('sync-new-post');
            })

            .then(() => {

                let snackbarContainer = document.querySelector('#confirmation-toast');
                let data = {message: "Your post was saved for synching!"}

                snackbarContainer.MaterialSnackbar.showSnackbar(data)

            })
            .catch(err => {
                console.log(
                    err, "STORING POST IN IndexedDb WAS UNSUCCESSFUL!"
                );
            })

        })

    }else{      // OVO JE ELSE IZJAVA U CIJEM OBIMU EXECUTE-UJE FALLBACK

        sendData();   // DAKLE OVDE SAM POZVAO POMENUTU FALLBACK FUNKCIJU

    }

})

```

**sw.js** FAJL:

```javascript
self.addEventListener('sync', function(ev){

    if(ev.tag === 'sync-new-post'){  

        ev.waitUntil(
            readAllData('sync-posts')

            .then(dataArray => {

                for(let data of dataArray){

                    // DAKLE KADA SAM DEFINISAO body Request-A JA SAM MU ZADAO JSON STRING KAO VREDNOST
                    // TO BI TREBALO DA AMENIM SA       FormData

                    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
                        method: "POST",
                        body: JSON.stringify({
                            id: data.id,
                            title: data.title,
                            location: data.location,
                            image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        }
                    })
                    .then(resp => {
                        console.log("Send Data: ", resp);

                        if(resp.ok){

                            deleteItemFromData('sync-posts', data.id)

                        }


                    })
                    .catch(function(err){
                        console.log('Error, while sending data', err)
                    })

                }
            })
        );
    }
})
```

## POCECU SA ADJUSTINGOM CODE-A; ODNOSNO IMPLEMENTACIJOM FormData ZA body PROPERTI (ARGUMENT OBJEKTA fetch METODE), U SLUCAJU POST REQUEST-OVA, MOG CODE-A

ONO STO MI VISE NIJE POTREBNO SU headers (A TU SAM RANIJE DEFINISAO DA JE REC O JASON PODACIMA) (headers MI NECE VISE BITI POTREBAN JER KADA POCNEM DA SALJEM FORM DATA, BICE ZAKLJUCENO UNDER THE HOOOD, PO DEFAULTU DA JE REC O FORM DATA, I ZATO MI NISU NI POTREBNI HEADERS)

DEFINISACU I VARIJABLU postData, CIJA CE VREDNSOT BITI INSTANTIATED FormData

ZATIM JE POTREBNO DA KORISTIM append METODU, KAKO BI DODAO DATA, POMENUTOJ FormData INSTANCI

DAKLE MOGU DA DODAJEM KEY/VALUE PAIRS, TU NISTA NIJE SPORNO

APPEND-OVACU DAKLE KEY VALUE PAIRS, KAO STO SU id I ODGOVARAJUCI ISO STRING TRENUTNOG Date (TRENUTNOG VREMENA)

ISTO VAZI I ZA location I ZA title

**ALI POSTOJI JEDAN BITNA RAZLIKA U REPREZENTOVANJU FORM DATA, OVIM PUTEM UZ POMOC FormData INSTANCE**

RAZLIKA SE OGLEDA U TOME STO JA *ZELIM DA POSALJEM FILE, ODNOSNO IMAGE*

**POSTO SE BACKGROUND SYNC SASTOJI, PRVO OD SLANJA PODATAKA U indexedDB, PRVO CU DA DEFINISEM DA SE ZAJEDNO SA OSTALIM PODACIMA, PROSLEDJUJE I ONA Blob INSTANCA, JER AKO SE PODSETIS ONOGA STO SAM RANIJE GOVORIO O indexedDB-JU: "IAKO NIJE NAMENJEN ZA STORING FAJLOVA, U indexedDB-JU SE MOGU STORE-OVATI FAJLOVI"**

DAKLE, DODACU DA SE TAJ BLOB PROSLEDI U INDEXIRANU BAZU PODATAKA, ZAJEDNO SA OSTALIM PODACIMA

**OVO JE BITNO DA DODAM, A TICE SE FormData**:

>>> KADA ZELIM DA APPEND-UJEM FILE, POMENUTOJ INSTANCI, JA ONDA KAO ARGUMENTE NAVODIMA

- KLJUC

- VREDNOST, TOG KLJUCA (**TO JE USTVARI FAJL** (*U MOM SLUCAJ UTO JE Blob INSTANCA*))

- FILE NAME (ODNOSNO DEFINISEM, IME ZA POMENUTI FILE)

feed.js FAJL:

```javascript

// SECAS SE DA SI RANIJE U CODE, DEKLARISAO picture VARIJABLU

// ... OVDE DAKLE STOJI OSTALI CODE, MEJU KOJEM JE I CODE VEZAN ZA KAMERU I CANVAS
// ... ODNOSNO onclick HANDLER (ZA CAPTURE DUGME), U KOJEM SE Blob DODELIO POMENUTOJ
//                                                                                     picture    VARIAJBLOJ


// NEKA ARGUMENT OVE FUNKCIJE BUDE OBJEKAT  SA SLEDECI MPROPERTIJIMA
// I AKO TE ZANIMA KOJI SU TO PROPERTIJI, MOZES POGLEDATI STA SAM DOLE
// OVOJ FUNKCIJI ZADAO KAO ARGUMENT

const sendData =  function({location, title, picture}){

    // OVAJ OBJEKAT CE SADA BITI SUVISAN
    /* const dataObject = {
        id: new Date().toISOString(),
        title: titleInput.value,
        location: locationInput.value,
        image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
    }
    */

    // MOGU DA INSTATICIZIRAM           FormData            INSTANCU

    const postData = new FormData();

    // APPEND-UJEM JOJ KEY/VALUE PAROVE

    postData.append('id', new Date().toISOString());
    postData.append('location', location);
    postData.append('title', title);

    // OVO MI JE DAKLE BITNO, SADA JA USTVARI APPEND-UJEM FILE, U FormData
    // SADA CE MI TREBATI SLEDECI ARGUMENTI:

    //                  KEY         VALUE (ODNOSNO FILE, A TO JE Blob INSTANCA)         FILENAME

    //  NEKA       'file'                            BUDE KEY (ILI IME PROPERTIJA)

    //              PROCITANA Blob INSTANCA          BUDE VALUE (VIDECES DA KADA BUDES POZVAO FUNKCIU sendData DA SAM JOJ PROSLEDIO I VREDNOST picture VARIJABLE (BICE VREDNOST PROPERTIJE DESTRUKTURIRANOG ARGUMENT OBJEKTA))

    //              VREDNSOT id KLJUCA + 'png'       BUDE FILENAME

    postData.append('file', picture, postData.get('id') + '.png')

    // ZASTO SAM DODAO '.png' A NE NEKU DRUGU EKSTENZIJU, ZA IME FAJLA
    // PA MOGAO SAM NAPRAVITI PROVERU, ALI NJACESCE, ONAJ SNAPSHOT, KOJI SE UZME OD canvas-A
    // JESTE U .png FORMATU


    // MOGU DA UKLONIM headers OBJEKAT (NECE BITI POTREBAN) I REDEFINISEM body

    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
        method: "POST",
        /* body: JSON.stringify(dataObject),
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
        } */

        // NEKA VREDNSOT body   PROPERTIJA SADA BUDE        FormData    INSTANCA

        body: postData

    })
    .then(resp => {
        console.log("Send Data: ", resp);
        updateUI(dataObject)
    })
}


const titleInput = document.querySelector('input#title');
const locationInput = document.querySelector('input#location');
const form = document.querySelector('div#create-post form');

form.addEventListener('submit', ev => {

    ev.preventDefault();

    if(titleInput.value.trim() === "" || locationInput.value.trim() === ""){
        alert("Please enter valid data!");

        return;
    }

    closeCreatingPostModal();


    if('serviceWorker' in window.navigator && 'SyncManager' in window){

        // PODACI TREBA DA SE STORE-UJU U indexedDB
        // A POST REQUEST SA
        //                      FormData INSTACOM
        // DEFINISEM (NE OVDE), VEC U SERVICE WORKERU, U OBIMU  ON sync  HANDLER-A
        // TAKO DA CU TAMO INSTATICIZIRATI    FormData


        navigator.serviceWorker.ready
        .then(swr => {

            let post = {
                id: new Date().toISOString(),
                title: titleInput.value,
                location: locationInput.value,

                // PORED PREDHODNIH PODATAKA, TU CE BIT I Blob INSTANCA
                // KOJU REFERENCIRA picture VARIJABLA

                picture: picture
            }


            writeData('sync-posts', post)
            .then(() => {
                swr.sync.register('sync-new-post');
            })

            .then(() => {

                let snackbarContainer = document.querySelector('#confirmation-toast');
                let data = {message: "Your post was saved for synching!"}

                snackbarContainer.MaterialSnackbar.showSnackbar(data)

            })
            .catch(err => {
                console.log(
                    err, "STORING POST IN IndexedDb WAS UNSUCCESSFUL!"
                );
            })

        })

    }else{      // OVO JE ELSE IZJAVA U CIJEM OBIMU EXECUTE-UJE FALLBACK (STO JE VEC POZNATO OD RANIJE, ODNOSNO DEFINISAO SAM ONDA KADA SAM SE BAVIO BACKGROUND SYNC-OM KONKRETNO)

        // DAKLE OVDE SAM POZVAO POMENUTU FALLBACK FUNKCIJU
        // NEKA JOJ ARGUMENTI BUDU SLEDECI

        // ps. OVA FUNKCIJA RANIJE NIJE ZAHTEVALAA NIKAKVE ARGUMENTE, ALI JA VISE VOLIM OVAK ODA DEFINISEM

        sendData({
            title: titleInput.value,
            location: locationInput.value,
            picture: picture    // DAKLE PROSLEDJUJEM I Blob, KOJEG REFERENCIRA picture VARIJABLA
        });

    }

})

```

**POSTO SAM GORE DEFINISAO STORING PODATAKA U INDEXED DB-JU;  USERVICE WORKER-U CU DEFINISATI VADJENJE TIH PODATKAK IZ INDEXED DB-JA I NJIHOVO SLANJE SERVERU, KROZ POST REQUEST; BAS KAO STO SAM URADIO I RANIJE, SAMO STO CU U OVOM SLUCAJU SLATI I IMAGE FAJL, KROZ FormData INTERFACE**

*sw.js* FAJL: (BACKGROUND SYNCHRONIZATION DEO)

```javascript
self.addEventListener('sync', function(ev){

    if(ev.tag === 'sync-new-post'){

        // IAKO NIJE TEMA ALI
        // KAD SAM VEC TU DA SE PODSETIM ZASTO JE OVDE MNOZINA sync-posts
        // PA TO IME JE ZADATO, JER JE MOGUCU UNOS VISE OBJEKATA U OBJECT STORE
        // DAKLE ,JA MOGU DA UNOSIM PODATKE I DA PRITISKAM POST DUGME, I OBJAKTI CE JEDAN ZA DRUGIM DA SE
        // UBACUJU U OBJECT STORE U indexedDB

        ev.waitUntil(
            readAllData('sync-posts')

            .then(dataArray => {

                // ZASTO JE OVO NIZ
                // PA TO JE ODLIKA JAKE ARCHIBALD-OVE PROMISED DB
                // DA store.getAll (POZVANE KAO POVRTNA VREDNOST readAllData UTILITY METODE, KOJU SAM JA 
                // KREIRAO U utility.js FAJLU, KORISTECI METODE IZ idb.js (LIBRARY-JA))

                // A TE PODATKE SAM JA NARAVNO DEFINISAO DA SE UNOSE U INEXIRANU BAZU PODATKAKA
                // U OBIMU onsubmit HANDLER-A

                for(let data of dataArray){

                    // DAKLE PROMISE JE RESOLVED SA SVIM DATA OBJEKTIMA
                    // SPREMNIM ZA SYNCHING, ODNOSNO SLANJE
                    // NA SERVER, ODNOSNO SLANJE DO CLOUD FUNCTION-A, KOJI TREBA
                    // DA IZVRSI STORING PODATAKA, U CLOUD DATABASE


                    // KREIRAM      FormData        INSTANCU

                    // I APPEND-UJEM JOJ DATA, KOJI SAM STORE-OVAO U indexedDB-JU

                    let postData = new FormData();

                    postData.append('id', new Date().toISOString());
                    postData.append('location', data.location);
                    postData.append('title', data.title);

                    // DAKLE, DODAJEM I Blob INSTANCU, KOJA JE VREDNSOPT pictures PROPERTIJA
                    // OBJEKTA IZ OBJECT STORA INDEKSIRANE BAZE PODATAKA BROWSER-A

                    postData.append('file', data.pricture, postData.get('id') + '.png')

                    // DAO SAM ISTA IMENA ZA KLJUC; I NA ISTI NACIN SAM DEFINISAO IME FAJLA
                    // KAK OSAM TO URADIO I U FALLBACK FUNKCIJI sendData, O KOJOJ SAM GORE GOVORIO

                    // 'file' JE DAKLE KLJUC
                    // Blob INSTANCA KOJA JE VREDNSOT PROPERTIJA picture JE VALUE
                    // IME FAJLA SAM DEFINISAO KAO VREDNSOT id-JA + '.png'

                    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
                        method: "POST",

                        /*POSTO SAM VISE NE ZELIM JSAON DATA, KAO VREDNOST body-JA VEC FormData INSTANCU*/
                        // SLEDECE JE COMMENTED OUT, A NE TREBAJU MI NI headers
                        /* body: JSON.stringify({
                            id: data.id,
                            title: data.title,
                            location: data.location,
                            image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json",
                        } */

                    // DAKLE body, ODNOSNO DATA, KOJI CE BITI U ReadableStream-U (Body MIXIN-U)
                        // U Request-U, POSLATOM SERVERU
                        // TREBA USTVARI DA BUDE            FormData        INSTANCA, KOJU SAM GORE KREIRAO

                        body: postData

                    })
                    .then(resp => {
                        console.log("Send Data: ", resp);

                        if(resp.ok){

                            deleteItemFromData('sync-posts', data.id)

                        }

                    })
                    .catch(function(err){
                        console.log('Error, while sending data', err)
                    })

                }
            })
        );
    }
})
```

## POSTO SAM SVE DEFINISAO NA CLIENT STRANI, UKLJUCUJUCI I SERVICE WORKER CODE; ONO STO MI SADA PREOSTAJE JESTE REDEFINISANJE, MOJE CLOUD FUNKCIJE, KOJA PRIHVATA REQUEST-OVE I STORE-UJE IH U DATABESE; JER VREDNOST, JEDNOG PROPERTIJA, KOJ IDOLAZI U BODY-JU REQUESTA, JESTE Blob INSTANCA, KOJA JE VREDNSOT PROPERTIJA file (DATA OBJEKTA)

DAKLE, CODE CLOUD FUNCTION-A BI SADA FAIL-OVAO, JER DATA KOJE ON PRIHAVATA TREBA DA BUDE U JSON FORMATU

NAIME TA INSTANCA TREBA DA BUDE UPLOADED U FILE STORAGE, A NE STAVLJENA U DATABASE

A ISTO TAKO, PRILIKOM STAVLJANJA OSTALIH PODATAKA U DATABASE, JA BIH TREBAO STAVITI URL, TE UPLOADED SLIKE, KAO VREDNSOT, PROPERTIJA CORESPONDING POSTA, KOJ ISE STORTE-UJE U DATABASE

JER KADA SE REQUEST-UJU POST-OVI NA CLOIENT STRANI, NJIMA TREBA PORED OSTALIH PODATAKA DA STIGNE I LINK SLIKE, KOJU JA ONDA DODELJUJEM src ATRIBUTU img ELEMENT-A

## ZATO CU SE SADA POZABAVITI KAKO TO DA ACCEPT-UJEM FILE UPLOAD, UZ POMOC FIREBASE-A

## POSTO SAM SLAO FormData, NA SERVER STRAN ICE M ITREBATI NESTO STO SLUZI ZA EXTRACTING FormData, I TO CE BITI PACKAGE formidable

INSTALIRAM **formidable** [PACKAGE](https://www.npmjs.com/package/formidable)

- cd functions

- npm install fomridable --save

DAKLE OVO CE MI OMOGUCITI LAKSI ACCES ZA FormData, KOJI REACH-UJE MOJ SERVER

NARAVNO, MOZE SE KORISTITI I ZA MOJ SOPSTVENI NODE SERVER, KOJI JOS NEMAM (JER CLOAUD FUNCTION BEHIND THE SCENES RADE ISTO)

## TAKODJE CE MI TREBATI NACI NZA STORING INCOMING FILES (U MOM SLUCAJU SLIKA REPRESENTED BY Blob), U FIREBASE-OV STORAGE (DAKLE GOVORIM O STORAGE-U, NE DATABASE-U)

JA ZA TO NE MOGU KORISTITI **firebase-admin** PACKAGE, KOJ ISAM RANIJE KORISTITO; JER MI ON NE DAJE ACCESS TO STORAGE, VEC SAM OZA DATABASE

**BEHIND THE SCENES FIREBASE STORAGE, USTVARI KORISTI GOOGLE CLOUD STORAGE**

ZATO UPRAVO MOGU KORISTITI **GOOGLE CLOUD STORAGE HELPER**

[@google-cloud/storage](https://www.npmjs.com/package/@google-cloud/storage)

DAKLE U functions folder-U EXECUTE-UJEM SLEDECU KOMANDU

- npm install '@google-cloud/storage' --save

OVO MOZDA SADA IZGLEDA SUPER COMPLICATED

USTVARI NIJE, I VEOMA JE DOABLE

NECU MORATI DA PISEM MNOGO CODE-A, KAKO BI DEFINISAO POTREBNO

ALI AKO IMAM MY OWN SERVER, SA Node.js, ODNOSNO Express.js APLIKACIJOM; MOGAO BI KORISTIT ANY APPROACH, I BILO KOJI STORAGE, KOJI VOLIM

## SADA CU U functions/index.js FAJLU, PULL-OVATI, POMENUTE NOVE DEPENDANCIES, KOJE SAM INSTALIRAO

**functions/index.js** FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// OVDE CU PULL-OVATI IN, ODNOSNO UVESTI, POMENUTA DVA NOVA PAKETA

// POCECU SA formidable

const formidable = require('formidable');

// A @google-cloud/storag ZAHTEVA I KONFIGURACIJSKI OBJEKAT, JER USTVARI KADA REQUIRE-UJEM TAJ PAKET
// DOBICU FUNKCIJU, KOJU CU ODMAH EXECUTE-OVATI SA KONFIGURACIJSKIM OBJEKTOM

// ZATO DEFINISEM CONFIGH OBJEKAT
// SA projectId- JEM I keyFilename-OM

// PRVI MOGU PRONACI U KONZOLI, POD Settings-IMA (PRITISNI MALI ZUPCANIK)
// A DRUGI USTVARI PREDSTAVLJA IME JSON FAJLA, KOJI JE TAKODJE U MOM functions FOLDER-U

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

// SA POMENUTOM KONFIGURACIJOM MOGU POZVATI ONOU FUNKCIJU KOJA CE BITI UVEZENA SA '@google-cloud/storage'

const gcs = require('@google-cloud/storage')(gcconfig);

// SADA MOGU OTICI U cors 'WRAPPER', I NASTAVITI DEFINISANJE


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6Btr"; // fake keys zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkI";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // DAKLE OVDE NASTAVLJAM DEFINISANJE
        // OVDE NAIME ZELIM DA EXTRACTUJEM IZ FormData
        // ZATO CU DEFINISATI I VARIJABLU, KOJU CU IMENOVATI, KAO formData
        // A EXTRACT-OVANJE VRSIM UZ POMOC formidable PAKETA, KOJEG SAM UVEZAO MALOPRE
        // ODNOSNO POTREBNO JE INSTATICIRATI, JEDAN KONSTRUKTOR, KOJI JE VREDNOST PROPERTIJA formidable
        // OBJEKATA    REC JE O       formidable.incomingForm

        const formData = new formidable.incomingForm();

        // POMENUTO JE HELPER, KOJI CE MI POMOCI DA GA IMEDIATE FETCH-UJEM FROM THE INCOMING REQUEST

        // OVO JE VEOMA CONVINIENT

        // DAKLE, JA SADA MOGU KORISTITI POMENUTU INSTANCU, KAKO BI FETCHOVAO Request, I PARSE-OVAO FORM DATA
        // IZ NJEGOVOG BODY-JA

        // TO RADIM TAKO STO PRIMENJUJEM parse METODU NAD OBJEKTOM INSTATICIRANIM UZ POMOC incomingForm()
        // A ARGUMENT, TE METODE, JE TRENUTNA Request INSTANCA
        // I TAKODJE I CALLBACK, KOJI CE BITI EXECTED, KAKDA EXTRACTION BUDE DONE

        // POMENUTI CALLBACK IMA TRI PARAMETRA
                            // OD KOJIH JE PRVI, USTVARI MOGUCI ERROR

                            // DRUGI JE fields ; PREDPOSTAVLJAM DA PREDSTAVLJA SVE TEKST PODATKE UNESENE
                                                 // I TEXT FIELDS-A

                            // TRECI JE files    ; PREDPOSTAVLJA, DA PREDSTAVLJA SVE FILE-OVE, ODNOSNO Blob
                                                    // INSTANCE, U MOM SLUCAJU ME BAS OVO ZANIMA, JER
                                                    // PRONALAZIM NACIN KAKO DA UPRAVO TAJ Blob ,KOJI 
                                                    // REPREZENTUJE IMAGE FAJL

        formData.paprse(request, function(err, fields, files){

            // U OBIMU OVOG CALLBACK-A, SADA MOGU ISKORITITI MENTIONED DATA
            // I MOGU REACH-OVATI DATABASE I TAKO  DALJE

            // NASTAVICU DEFINISANJE CODE-A, KADA NESTO OBJASNIM POD SLEDECIM PODNASLOVOM

        })

        admin.database().ref('posts').push({
            id: request.body.id,
            title: request.body.title,
            location: request.body.location,
            image: request.body.image
        })
        .then(function () {
            webpush.setVapidDetails(
                "mailto:bajic.rade2@gmail.com",
                publicVapidKey,
                privateVapidKey
            );
            return admin.database().ref('subscriptions').once('value');
        })
        .then(function (subscriptions) {
            subscriptions.forEach(function (sub) {
                var pushConfig = {
                    endpoint: sub.val().endpoint,
                    keys: {
                        auth: sub.val().keys.auth,
                        p256dh: sub.val().keys.p256dh
                    }
                };

                webpush.sendNotification(
                    pushConfig,
                    JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                ))
                .catch(function(err) {
                    console.log(err);
                })

            });

            return response.status(201).json({message: 'Data stored', id: request.body.id});
        })
        .catch(function (err) {
            response.status(500).json({error: err});
        });
  
    });
});
```

## FILE SYSTEM MODUL (nativni node modul) I KORISCENJE NECEGA STO SE ZOVE BUCKET

SADA CE MI BITI POTREBAN [FILE-SYSTEM MODUL](https://nodejs.org/api/fs.html#fs_file_system), KOJI JE NATIVNI node.js MODUL, *DAKLE, NEMA POTREBE DA GA INSTALIRAM, SAMO TREBA DA UVEZEM*: '**fs**'

I POMENUTI MODUL (KADA NAD NJIM PRIMENIM rename FUNKCIJU) CE MI POSLUZITI DA **PROCITAM PATH FILE-A, KOJI JE REPRESENTED BY Blob; JER ON CUVA TU INFORMACIJU (ODNOSNO GDE SE FAJL REPRESENTED BY Blob USTVARI NALAZI), KOJI JE POSLAT**; **A POSLUZICE MI I DA FAJL SLIKE STAVIM U TEMPORARY FOLDER NA CLOUD-U, (ODNOSNO DA DEFINISEM NOVI PATH, NA KOJEM CE SE NACI FAJL, KOJI JE REPRESENTED BY, POMENUTI BLOB, KOJI JE POSLAT SERVERU, ODNOSNO KOJI JE DE VREDNOSTI BODY-JA Request-A)**

**functions/index.js** FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);

// IMPORTOVACU POMENUTI fs (FILE SYSTEM) NATIVE PAKET Node.js-A

const file_system = require('fs');

// ******************************************************


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6Btr"; // fake keys zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkI";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.incomingForm();

        formData.parse(request, function(err, fields, files){

            // REKAO SAM DA files PREDSTAVLJA SVE FAJLOVE, KOJI SU POSLATI SA JEDNIM REQUEST-OMN
            // (U MOM SLUCAJU TO JE SAMO JEDAN FAJL, ODNOSNO JEDAN Blob KOJI
            // REPREZENTUJE FILE SLIKE)
            // JA TOJ Blob INSTANCI, MOGU PRISTUPITI, PUTEM IMENA PROPERTIJA, CIJA JE Blob INSTANCA VREDNOST
            // MISLIM NA PROPERTI, ODNOSNO KLJUC KOJI JE APPEND-OVAN NA FormData

            // MOM Blob-u SLIKE, SAM NA CLIENT STRANI, PRE SLANJA FormData, JA USTVARI ZADAO
            //     'file'       KAO KLJUC

            // STO BI ZNACILO DA POMENUTOM Blob-U, U OVOM OBIMU, MOGU PRISTUPITI, KAO

                            //                                                          files.file

            // SADA NA POMENUTOM fs MODULU PRIMENJUJEM rename FUNKCIJU
            // ONA ZAHTEVA DVA PARAMETRA

                                    // PRVI JESTE STAVARNI PATH DO Blob-A
                                    // JER JE MOGUCE PRITUPITI         path     PROPERTIJU Blob INSTANCE
                                    // KAO STO SAM I REKAO

                                    // DRUGI JE ZELJENO JE, NOVI PATH, ODNOSNO PATH
                                    // NA KOJI CE FAJL BITI PREMESTEN

            // U MOM SLUCAJU, ODNOSNO U SLUCAJU FIREBASE CLOUD-A, TEMPORARY FOLDER CE BITI MESTO NA KOJE
            // CE BITI PREMESTEN FAJL

            file_system.rename(
                files.file.path,        // path JE PROPERTI Blob INSTANCE (path JE URL GDE SE NALAZI FAJL)

                '/tmp/' + files.file.name         // tmp JE TAJ TEMPORARY FOLDER, U KOJI SMESTAM FAJL
            )                                     // DAKLE, JA SAM DEFINISAO NJEGOV NOVI PATH, ODNOSNO
                                                  // PATH, NJEGOVE NOVE LOKACIJE, ODNOSNO TRENUTNE
                                                  // LOKACIJE POSTO TU NECE OSTATI ZAUVEK

                                                  // DEFINISUCI PATH, JA SAM DEFINISAO I NOVO IME FAJLA
                                                  // A KAO IME FAJLA SAM ISKORISTIO ONO IME
                                                  // KOJE SAM DAO Blob-U, PRI NJEGOVOM INSTATICIRANJU
                                                  // PRE SLANJE POST REQUEST-A

            // OVAJ FAJL, SADA TREBA DA SE UZME SA TEMPORARY LOKACIJE
            // I UPLOAD-UJE U FILE STORAGE NA FIREBASE-U

            // ZA TO CU ISKORISTITI PAKET, KOJI SAM INSTALIRAO, A TO JE ONO PROIZISLO IZ
            // POZIVANJA PAKETA, ODNOSNO POZIVANJA UVEZENE FUNKCIJE @google-cloud/storage

            // ONO STO CU JA SADA USTVARI URADITI JESTE MOVING, MOG FAJLA, SA NJEGOVE PRIVREMENE
            // LOKACIJU, U NESTO STO SE ZOVE:

            //                                          BUCKET          GOOGLE CLOUD STORAGE-A
                                                                    // ODNOSNO FIREBASE-OVOG STORAGE-A

            // KREIRAM NOVI BUCKET, TAKO STO PRIMENIM           bucket()      METODU
            // NAD ONIM STO REFERENCIRA gcs FARIJABLA (gcs JE GOOGLE CLOUD STORAGE FIREBASE-A)

                        //  ARGUMENT MOGU PRONACIK KADA OTVORIM
                        //      Storage         TAB U FIREBASE KONZOLI, MOG PROJEKTA

                                // JEDINI ARGUMENT JE         BUCKETNAME
                                // POMENUTO JE UPRAVO ONAJ LINK KOJI PRONALAZIM NA POCETKU KADA OTVORIM
                                // POMENUTI TAB

            const bucket = gcs.bucket('instapwaclone.appspot.com');

            // I POMENUTO MI JE DALO PRISTUP BUCKET-U, KROZ GOOGLE CLOUD STORAGE

            // JA SADA MOGU INICIJALIZOVATI UPLOAD FAJLA, PRIMENOM      upload()        METODE
            // NAD, POMENUTIM BUCKET-OM

                            // ARGUMENT 1 JE ONAJ PATH, KOJI JE TEMPORARY PATH LOKACIJE, GDE SE NALAZI FAJL

                            // ARGUMENT 2 JE KONFIGURACIJSKI OBJEKAT (ALL PROVIDED BY formidable)

                            // ARGUMENT 3, JESTE CALLBACK FUNKCIJA (O NOJ CU RECI NESTO KASNIJE)


            // JAS USTVARI NISAM MORAO KORISTITI TEMPRARY LOKACIJU, ODNOSNO STAVLJANJA FAJLA U tmp FOLDER,
            // VEC SAM MOGAO DIREKTNO FAJL UPLOAD-OVATI U BACKET FIREBASE-OVOG, ODNOSNO GOOGLE CLOUD 
            // STORAGE-A
            // ALI TO JE MERA PREDOSTROZNOSTI, KOJA SE PRAVI, KKO SLUCAJNO FAJL NE BI BIO OBRISAN I SLICNO
            // ZATO IPAK TREBA FAJL STAVITI U tmp FOLDER, PRE NJEGOVOG UPLOAD-A U BUCKET


            // POZIVAM UPLOADING

            bucket.upload(
                '/tmp/' + files.file.name,                          // 1. TEP PATH LOCATION
                
                
                {                                                   // 2. CONFIG OBJEKAT
                    
                    
                    uploadType: 'media',      // ZATO STO JE IMAGE U PITANJU

                    metadata: {                 // METADATA ZA UPLOAD

                        metadata: {             // METADATA ZA UPLOADED FAJL

                            contentType: files.file.type

                            // A OVO JE MOZDA NAJVAZNIJE IZ OVOG KONFIGURACIJSKOG OBJEKTA, A TO JE
                            // DOWNLOAD URL; A TO CE MI OMOGUCITI EASY ACCESS, CAK IAKO NISAM GOOGLE CLOUD
                            // USER; A NI JEDAN OD KORISNIKA NECE BITI, I ZATO MORAM GENERISATI

                                                            // PUBLIC DOWNLOAD URL

                            //  FIREBASE OVO RADI PO DEFAULTU AKO KORISTIM FIREBASE-OV   SDK
                            // ODNOSNO (Software Development Kit)
                            // ALI JA GA NE MOGU KORISTIT INA SERVER STRANI 
                            // OVO POMENUTO M INIJE JASNO, JER UOPSTE NE ZNAM STA JE SDK
                            // USTVARI GOVORIO SAM O POMENUTOME (ONAJ CODE IZ SETTINGS/SERVICE ACCOUNTS)

                            // MORAM KORISTITI ZATO JEDAN ALGORITAM, ZA KOJI KAZU DA JE EASY

                            // ONO STO CU DEFINISATI, USTVARI, JESTE    firebaseStorageDownloadTokens
                            // VREDNOST, MORA DA BUDE JEDINSTVEN ODNOSNO UNIQUE ID STRING

                            // ZA OVO CE MI TREBATI, JEDAN NOVI PAKET, KOJI CU INSTALIRATI

                            // NASTAVICU POD SLEDECIM PODNASLOVOM

                        }
                    }
                },

                function(){                                             // 3. CALLBACK O KOJEM CU NESTO VISE
                                                                                // RECI KASNIJE

                }
            )



        })

        // ******************************************************

        admin.database().ref('posts').push({
            id: request.body.id,
            title: request.body.title,
            location: request.body.location,
            image: request.body.image
        })
        .then(function () {
            webpush.setVapidDetails(
                "mailto:bajic.rade2@gmail.com",
                publicVapidKey,
                privateVapidKey
            );
            return admin.database().ref('subscriptions').once('value');
        })
        .then(function (subscriptions) {
            subscriptions.forEach(function (sub) {
                var pushConfig = {
                    endpoint: sub.val().endpoint,
                    keys: {
                        auth: sub.val().keys.auth,
                        p256dh: sub.val().keys.p256dh
                    }
                };

                webpush.sendNotification(
                    pushConfig,
                    JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                ))
                .catch(function(err) {
                    console.log(err);
                })

            });

            return response.status(201).json({message: 'Data stored', id: request.body.id});
        })
        .catch(function (err) {
            response.status(500).json({error: err});
        });
  
    });
});
```

## JA SADA MORAM INSTALIRATI NOVI PAKET, KOJI CE MI OMOGUCITI DA DEFINISEM TOKEN, ODNOSNO UNIQUE STRING; PAKET SE ZOVE uuidv4

[npm](https://www.npmjs.com/package/uuidv4)

- cd functions

- npm install uuidv4 --save

**OVO JE USTVARI FUNKCIJA KOJA CE GENERISATI TAJ UNIQUE ID; ODNOSNO U TOM SLUCAJU SE GENERISE VISE KLJUCEVA, ODNOSNO VISE UNIQUE ID-JEVA**

*BOLJE JE DA TO PRIKAZEM PUTEM PRIMERA*

**functions/index.js** FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);

const file_system = require('fs');


// IMPORTOVACU, POMENUTI PAKET

const UUID = require('uuidv4');    // NEKA BUDE VELIKO SLOVO

// ******************************************************


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6Btr"; // fake keys zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkI";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.incomingForm();

        // POMENUTI UNIQUE STRING MOGU ZADATI DA OVDE BUDE VREDNOST VARIJABLE

        const uuid = UUID();    // DAKLE, POZVAO SAM UVEZENU FUNKCIJU

        formData.parse(request, function(err, fields, files){

            file_system.rename(
                files.file.path,

                '/tmp/' + files.file.name
            )

            const bucket = gcs.bucket('instapwaclone.appspot.com');

            bucket.upload(
                '/tmp/' + files.file.name,
                {
                    uploadType: 'media',

                    metadata: {

                        metadata: {

                            contentType: files.file.type,

                            // ZA PROPERTI     firebaseStorageDownloadTokens      DEFINISEM
                            // VREDNOST, ONE VARIJABLE
                            // PREDPOSTAVLJAM DA TA VARIJABLA SADA IMA UNIQUE ID, KAO VREDNOST
                            // JER POVRATNA VREDNOST UVEZENE FUNKCIJE, TREBA DA BUDE
                            // UNIQUE ID

                            firebaseStorageDownloadTokens: uuid

                            // NA OSNOVU OVOGA, FIREBASE BI TREBAL ODA GENERISE DOWNLOAD URL
                            // STO JE VEOMA CONVINIET THING

                            // DAKLE OVO JE VEC NAPRAVILO UPLOAD

                        }
                    }
                },

                function(){
                    // SADA MOGU DA SE POSVETIM DEFINISANJEM CODE-A, OVOG CALLBACK-A
                }

            )



        })

        // ******************************************************

        admin.database().ref('posts').push({
            id: request.body.id,
            title: request.body.title,
            location: request.body.location,
            image: request.body.image
        })
        .then(function () {
            webpush.setVapidDetails(
                "mailto:bajic.rade2@gmail.com",
                publicVapidKey,
                privateVapidKey
            );
            return admin.database().ref('subscriptions').once('value');
        })
        .then(function (subscriptions) {
            subscriptions.forEach(function (sub) {
                var pushConfig = {
                    endpoint: sub.val().endpoint,
                    keys: {
                        auth: sub.val().keys.auth,
                        p256dh: sub.val().keys.p256dh
                    }
                };

                webpush.sendNotification(
                    pushConfig,
                    JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                ))
                .catch(function(err) {
                    console.log(err);
                })

            });

            return response.status(201).json({message: 'Data stored', id: request.body.id});
        })
        .catch(function (err) {
            response.status(500).json({error: err});
        });
  
    });
});
```

## DAKLE, SADA CU DEFINISATI I CALLBACK, ARGUMENT, POMENUTE upload() METODE BUCKET-A

**functions/index.js** FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);

const file_system = require('fs');

const UUID = require('uuidv4');

// ******************************************************


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6Btr"; // fake keys zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkI";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.incomingForm();

        const uuid = UUID();

        formData.parse(request, function(err, fields, files){

            file_system.rename(
                files.file.path,

                '/tmp/' + files.file.name
            )

            const bucket = gcs.bucket('instapwaclone.appspot.com');

            bucket.upload(
                '/tmp/' + files.file.name,
                {
                    uploadType: 'media',

                    metadata: {

                        metadata: {

                            contentType: files.file.type,

                            firebaseStorageDownloadTokens: uuid

                        }
                    }
                },

                function(err, file){    // ARGUMENTI OVOG CALLBACK-A, MOGU BITI
                                        //       ERROR       I      UPLOADED FILE
                    if(!err){


                        // OVDE SADA MOGU REACH-OVATI DATABASE I EXECUTE-OVATI, SAV CODE OD RANIJE
                        // TO SAM I URADIO

                        admin.database().ref('posts').push({
                            // RANIJE SAMOVDE KORISTIO request.body KAKO BI PRISTUPIO
                            // PROPERTIJU, KOJI JE NARAVNO TADA BIO PARSED JSON

                            // SADA POSTO KORISTITM DATA, KORISTICU fields  (JEDAN OD PARAMETARA
                                                                            //  CALLBACK ARGUMENTA
                                                                            // GORE POZVANE parse METODE (VEZAN OZA formidable PAKET))

                            id: fields.id,
                            title: fields.title,
                            location: fields.location,

                            // ALI OVDE NE KORISTIM fields, VEC
                            // ZNAM DA image PROPERTI TREBA DA IMA VREDNOST, KOJA JE URL SLIKE IZ STORAGE-A
                            // POSTO JE SLIKA UPLOADED, DOSTUPAN MI JE NJEN URL

                            // MEDJUTIM, ON SE MORA IZGRADITI (URL)

                            // OSNOVA JE UVEK ISTA

                            //    'https://firebasestorage.googleapis.com/v0/b/'

                            // AKO SAM RANIJE MANUELNO UPLOAD-OVAO FAJL U STORAGE NA FIREBASU (STO JESAM)
                            // MOAGAO SAM PROCITATI, POMENUTI URL KADA IZABEREM BILO KOJI UPLOADED FILE

                            //  SLEDECI DEO JE IMA BUCKETA-A (MOGU GA VIDETI NEGDE GORE)
                            // A MOGU MU I PRISTUPITI
                            //                        bucket.name               // to je ustvari on osto mogu procitati i u konzoli u storage-u     'instapwaclone.appspot.com'

                             // SLEDECI DEO URL JE

                             //                         '/o/'         // PREDSTAVLJA OBJEKAT

                            // I ONDA KORISTIM METODU, KOJA SE ZOVE

                            //                                          decodeURIComponent()

                            // POMENUTO JE DEFAULT FUNKCIJA, Node.js , KOJU MOGU OVDE KORISTITI
                            // ARGUMENT JOJ JE IME FAJLA, ODNOSNO
                            //                                                      file.name

                            // MEDJUTIM, POTREBNO JE CHAIN-OVATI I QUERY PARAMETAR, ODNOSNO UPITNIK ('?')

                            // ZATIM POSLE UPITNIKA IDE         alt=media     STO INDICIRA DA JE REC O MEDIA TYPE-U

                            // ZATIM IDE        &       (AND)

                            // I SLEDECI DEO JE JAKO VAZAN JER SE RADI O TOKEN-U, ODNOSNO O UNIQUE ID-JU
                            // GENERISANOM RANIJE UZ POMOC PAKETA uuidv4


                            // ON JE VREDNOST,      uuid         VARIJABLE, A PRE NJEGA IDE      "token="



                            image: 'https://firebasestorage.googleapis.com/v0/b/' + bucket.name + '/o/' +
                                    file.name + '?alt=media&token=' + uuid


                            // DAKLE JA KORISTIM OVDE GORE URL (ODNOSNO STARAM SE DA TAJ URL BUDE STORED U
                            // DATABASE)
                            // KOJI JE KADA GORE POGLEDAM NJEGOVE GRADIVNE
                            // ELEMENTE
                            // USTVARI CRIPTICLLY LOOKING,
                            // I NJEGA JE DAKLE FIREBASE GENERISAO DA BUDE PUBLICLY ACESSIBLE URL


                        })
                        .then(function () {
                            webpush.setVapidDetails(
                                "mailto:bajic.rade2@gmail.com",
                                publicVapidKey,
                                privateVapidKey
                            );
                            return admin.database().ref('subscriptions').once('value');
                        })
                        .then(function (subscriptions) {
                            subscriptions.forEach(function (sub) {
                                var pushConfig = {
                                    endpoint: sub.val().endpoint,
                                    keys: {
                                        auth: sub.val().keys.auth,
                                        p256dh: sub.val().keys.p256dh
                                    }
                                };

                                webpush.sendNotification(
                                    pushConfig,
                                    JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                                ))
                                .catch(function(err) {
                                    console.log(err);
                                })

                            });

                            // OVDE SAM KAO DEO RESPONSE-A, KOJ ISE SALJE CLIENTU, USTVARI PRISTUPIO
                            // OPET PREKO Request-A, JEDNOJ VREDNSOTI, A TO JE id
                            // MORAM KORISTITI fields

                            // return response.status(201).json({message: 'Data stored', id: request.body.id});

                            return response.status(201).json({message: 'Data stored', id: fields.id});   // DAKLE OVDE SAM ISKORISTIO fields.id UMESTO request.body.id
                        })
                        .catch(function (err) {
                            response.status(500).json({error: err});
                        });

                    }else{

                        // AKO IMAM POTENCIJALNI ERROR, ZELI MDA GA HANDLE-UJEM
                        // OVDE CU GA SAMO LOGGOVATI

                        console.log(err);
                    }


                }

            )



        })

        // ******************************************************

        // SAV CODE OD RANIJE CU ISKOMENTARISATI, JER SAM GA USTVARI REDEFINISAO I STAVIO GORE U
        // OBIM CALLBACK ARGUMENTA upload() FUNKCIJE

        /* admin.database().ref('posts').push({
            id: request.body.id,
            title: request.body.title,
            location: request.body.location,
            image: request.body.image
        })
        .then(function () {
            webpush.setVapidDetails(
                "mailto:bajic.rade2@gmail.com",
                publicVapidKey,
                privateVapidKey
            );
            return admin.database().ref('subscriptions').once('value');
        })
        .then(function (subscriptions) {
            subscriptions.forEach(function (sub) {
                var pushConfig = {
                    endpoint: sub.val().endpoint,
                    keys: {
                        auth: sub.val().keys.auth,
                        p256dh: sub.val().keys.p256dh
                    }
                };

                webpush.sendNotification(
                    pushConfig,
                    JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                ))
                .catch(function(err) {
                    console.log(err);
                })

            });

            return response.status(201).json({message: 'Data stored', id: request.body.id});
        })
        .catch(function (err) {
            response.status(500).json({error: err});
        });
   */
    });
});
```

## SADA MOGU DA DEPLOY-UJEM I TESTIRAM MOJ APP; ALI NISAM DEFINISAO HANDLE-OVANJE JEDNOG ERROR-A; A TO CE IZAZVATI SAMO PO SEBI ERROR PRI DEPLOYMENTU ZATO MORAM TO PRVO DA URADIM

functions/index.js FAJL:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});
const serviceAccount = require("./instaclone-fb-key.json");
const webpush = require('web-push');

// *****************************************************

const formidable = require('formidable');

const gcconfig = {
    projectId: 'instapwaclone',
    keyFilename: 'instaclone-fb-key.json'
}

const gcs = require('@google-cloud/storage')(gcconfig);

const file_system = require('fs');

const UUID = require('uuidv4');

// ******************************************************


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom"; // fake keys zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122N";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {

    cors(request, response, function () {

        // **************************************************

        const formData = new formidable.IncomingForm();

        const uuid = UUID();

        formData.parse(request, function(error, fields, files){

            if(!error){                  // MORAM OVO DA DEFINISE, JER SE ERROR MORA HANDLE-OVATI
                                         // NARAVNO, HANDLE-UJEM GA U else IZJAVI

                file_system.rename(
                    files.file.path,

                    '/tmp/' + files.file.name
                )

                const bucket = gcs.bucket('instapwaclone.appspot.com');

                bucket.upload(
                    '/tmp/' + files.file.name,
                    {
                        uploadType: 'media',

                        metadata: {

                            metadata: {

                                contentType: files.file.type,

                                firebaseStorageDownloadTokens: uuid

                            }
                        }
                    },

                    function(err, file){

                        if(!err){

                            admin.database().ref('posts').push({

                                id: fields.id,
                                title: fields.title,
                                location: fields.location,


                                image: 'https://firebasestorage.googleapis.com/v0/b/' + bucket.name + '/o/' +
                                        file.name + '?alt=media&token=' + uuid




                            })
                            .then(function () {
                                webpush.setVapidDetails(
                                    "mailto:bajic.rade2@gmail.com",
                                    publicVapidKey,
                                    privateVapidKey
                                );
                                return admin.database().ref('subscriptions').once('value');
                            })
                            .then(function (subscriptions) {
                                subscriptions.forEach(function (sub) {
                                    var pushConfig = {
                                        endpoint: sub.val().endpoint,
                                        keys: {
                                            auth: sub.val().keys.auth,
                                            p256dh: sub.val().keys.p256dh
                                        }
                                    };

                                    webpush.sendNotification(
                                        pushConfig,
                                        JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
                                    ))
                                    .catch(function(err) {
                                        console.log(err);
                                    })

                                });

                                return response.status(201).json({message: 'Data stored', id: fields.id});
                            })
                            .catch(function (err) {
                                response.status(500).json({error: err});
                            });

                        }else{

                            console.log(err);
                        }


                    }

                )
        
            }else{

                // EVO OVDE HANDLE-UJEM ERROR, KOJI SAM RANIJE ZABORAVIO DA HANDLE-UJEM
                // ODNOSNO SAMO GA LOGUJEM

                console.log(error)
            }


        })

    });
});
```