# STAVLJANJE SLIKE U STORAGE NA SERVER-U

DA NESTO RAZJASNIM PRE ONOGA STO JE TEMA OVE LEKCIJE

**KADA GOVORIM O Blob-U, U PITANJU JE FAJL, KOJI SE MORA TRANSFORMISATI U objectUrl (DOM String KOJ ISADRZI URL) DA BIH IMAO VALIDNU VREDNOST ZA DODAVANJE src ATRIBUTU NEKE SLIKE ,ODNOSNO TREBA MI URL KAK OBIH MOGA OREFERENCIRATI SOURCE OBJECT, ODNOSNO FAJL, KOJI REPREZENTUJE Blob INSTANCA**

**KADA IMAM BASE64 URI VREDNOST, TO JE STRING VREDNOST, KOJA MORA BITI TRANSFERED U Blob, KAKO BI SE MOGLA KORISTITI, DALJE KAKO SAM POMENUO**

> DA SADA NASTAVIM

IMAGE, KOJI IMAM, KADA PRITISNEM KAPTURE, ZIVI SAMO U canvas ELEMENT-U

**JA MOGU UZETI BASE64 FORMAT TE SLIKE OD CANVASA**

NE BIH SMEO DA STORE-UJEM OVAJ BASE64 U DATABASEU, ODNOSNO TAJ NJEN BASE64 URI, JER JE TO OGROMAN STRING

MORAM GA PRETVORITI U Blob INSTANCU (U SUSTIN ITREBA MI FAJL), KOJI CU ONDA STORE-OVATI U STORAGE-U NA FIREBASE-U, ODNOSNO UPLOAD-OVACU GA TAMO

## JA SAM RANIJE KORISTITO URL.createObjectURL(), SA Blob-OM KAO ARGUMENTOM KAKO BIH KREIRAO VALIDAN DOM STRING KOJI MOGU DODELITI src ATRIBUTU (CISTO SE PODSECAM)

- TADA JA REQUEST-UJEM SLIKU (ODNOSNO NJEN LINK) IZ NEKOG STORAGE-A (IMAJ NA UMU DA NE GOVORIM O DATABASE-U (U DATABASE-U NIKAD DAKLE NE STAVLJAM BASE64 VREDNOST))

- TADA U Body MIXIN-U, KOJI JE DEO Response-A, JA DOBIJAM STRING U JSON FORMATU, KOJI ONDA MOGU PRETVORITI U Blob INSTANCU, KADA NAD Response-OM PRIMENIM METODU, NJEGOVOG Body MIXIN-A

- DA, MISLIO SAM NA blob() METODU

- POMENUTA Blob INSTANCA ODNOSNO BINARY LARGE OBJECT MORA SE PRETVORITI U DO MSTRING, ODNOSNO URL, KOJI JE PREFIXED SA "data:" , I TAKAV JE VALIDNA VREDNOST src ATRIBUTA NEKOG img ELEMENTA, ILI url FUNKCIJE U CSS-U

## AKO SE PODSETIS: file-loader I url-loader; BICE TI MOZDA BRZE JASNIJE OVO

U SUSTINI JA SAM TADA KORISTIO url-loader, KAKO BI TRANSFORMISAO-OVAO DATA, KAKO BI DIREKTNO MOGAO KORISTITI BASE64 U SLUCAJU KADA JE TAJ BASE64 STRING BIO MANJI (DEFINISANJE LIMITA), I TADA BIH SLIKU DIREKTNO KORISTIO U JAVASCRIPTU, BEZ POSTOJANJA FILE U BUILD FOLDERU

DAKLE NA TAJ NACIN SLIKA JE BILA REPRESENTED U BASE64 DATA FORMATU DIREKTNO U JAVASCRIPT-U

I TAKO JE SLIAK STIZALA SA SERVERA ZAJEDNO SA JAVASCRIPT FAJLOM (DAKLE SAMO JEDAN NETWORK REQUEST)

A file-loader JE BIO ODGOVORAN ZA TO DA NA RESOLVE-UJE import()/require() NA FILE-U INTO URL

## ALI STA, KADA ZELIM DA OD Data URI-A (BASE64 VREDNOSTI), PROCITANOG OD CANVAS-A, NAPRAVIM Blob INSTANCU, KOJU TREBA DA POST-UJEM NA DATABASE, KAO DEO Body-JA NEKOG Request-A

MORAM KORISTITI METODU, KOJA BASE64, ODNOSNO Data URI TRANSFORMISE U Blob INSTANCU

ZA TO CU KORISTITI, JEDNU FUNKCIJU, PREKOPIRANU, KOJU CU PROSLEDITI U utility.js FAJL

**utility.js** FAJL, KOJI SE PRVI UCITAVA U MOJ HTML, I CIJE FUNKCIJE KORISTE SLEDECI FAJLOVI:

```javascript
// DEFINISAO SAM JE NA SAMOM DNU FAJLA, POSLE OSTALIH METODA DODATIH RANIJE

function dataURItoBlob(dataURI) {
  var byteString = atob(dataURI.split(',')[1]);
  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
  var ab = new ArrayBuffer(byteString.length);
  var ia = new Uint8Array(ab);
  for (var i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }
  var blob = new Blob([ab], {type: mimeString});
  return blob;
}
```

## POTREBNO JE DA KREIRAM JEDNU GLOBALNU VARIJABLU, KOJOJ CU DODELITI Blob INSTANCU KAO VREDNOST, NARAVNO, NAKO NSTO KREIRAM TAJ Blob, ITAJUCI BASE64 VREDNSOT SLIK-E IZ canvas-A I TRANSFORMISUCI JE UZ POMOC GORNJE FUNKCIJE U Blob INSTANCU

TO MOGU URADITI U OBIMU HANDLER-A, KOJI JE onclick HANDLER, ZAKACEN NA CAPTURE DUGME

U TOM HANDLERU, JA SAM ONAJ MEDIA STREAM, IZ KAMERE INSERTED U video ELEMENT; USTVARI CAPTURE-OVAO, I STAVLJAO JEDAN SNAPSHOT U canvas ELEMENT

E PA TADA JA MOGU IZ CANVASA IZVUCI TAJ BASE64 VALUE SNAPSHOT-A, I PRETVORITI GA U BLOB, I DODELITI GA VARIJABLOJ

feed.js

```javascript
const videoPlayer = document.querySelector('video#player');
const canvasElement = document.querySelector('canvas#canvas');

const captureButton = document.querySelector('button#capture-btn');


const imagePicker = document.querySelector('input#image-picker');
const imagePickerArea = document.querySelector('div#pick-image');

//  DEKLARISACU OVDE VARIJABLU, KOJA CE SKALDISTITI blob INSTANCU, KOJU CU
//  DODELITI TEK DOLE U onclick HANDLER-U, ZAKACENOM NA CAPTURE DUGME

let picture;

const initializeMedia = function(){

    if(!('mediaDevices' in window.navigator)){

        window.navigator.mediaDevices = {};

    }

    if(!('getUserMedia' in window.navigator.mediaDevices)){

        window.navigator.mediaDevices.getUserMedia = function(constraints){

            let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

            if(!getUserMedia){

                return Promise.reject(new Error('getUserMedia is not implemented'));

            }

            return new Promise((resolve, reject) => {

                getUserMedia.call(
                    window.navigator,
                    constraints,
                    resolve,
                    reject
                );

            })

        }

    }


    window.navigator.mediaDevices.getUserMedia({video: true})

    .then(mediaStream => {

        videoPlayer.srcObject = mediaStream;

        videoPlayer.style.display = "block";
    })

    .catch(err => {

        imagePickerArea.style.display = "block";
        captureButton.style.display = "none";

    })


};

// ********************************************************
// ********************************************************

captureButton.addEventListener('click', ev => {

    canvasElement.style.display = "block";

    videoPlayer.style.display = "none";

    captureButton.style.display = "none";

    let context = canvasElement.getContext('2d');

    context.drawImage(
        videoPlayer,
        0,
        0,
        canvasElement.width,
        canvasElement.width / (videoPlayer.videoWidth /  videoPlayer.videoHeight)
    );

    videoPlayer.srcObject.getVideoTracks().forEach(track => {
        track.stop();
    })

    // CITAM BASE64 VREDNOST SA canvas-A, TAK OSTO NA NJMU PRIMENIM METODU toDataURL()
    // ZATIM, TU VREDNOST, PROSLEDJUJEM U UTILITY METODU    dataURItoBlob
    // IZ TOGA CE PROIZICI Blob INSTANCA

    picture = dataURItoBlob(canvasElement.toDataURL());

    // MOGU SADA DA REDEFINISEM POST REQUEST, PO KOJEM SE PRVO STAVLJA
    // OVA SLIKA U STORAGE

    // ALI I NJEN URL SA TO STORAGE-A, TREBA DA BUDE ONO STO CE BITI U
    // JEDNOM OBJECT-U DATABASE, SA OSTALIM PODACIMA POST-A

})

// ********************************************************
// ********************************************************

const buttonOther = document.querySelector('.plusButtonOther');

const openCreatingPostModal = ev => {

    initializeMedia();

    const elem = document.querySelector('div#create-post');
    elem.classList.remove('closeP');
    elem.classList.add('openP');
};

const closeCreatingPostModal = ev => {
    const elem = document.querySelector('div#create-post');

    elem.classList.remove('openP');
    elem.classList.add('closeP');

    videoPlayer.style.display = "none";
    imagePickerArea.style.display = "none";

}

buttonOther.addEventListener('click', openCreatingPostModal)

buttonClose.addEventListener('click', closeCreatingPostModal);
```

## :exclamation::exclamation::exclamation: MEDJUTIM SAZNAO SAM DA canvas IMA METODU: toBlob()    :question::question::question::question:

PITAM SE DA LISAM MOGAO KORISTITI [POMENUTU METODU](https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob) canvas-A, ZA DOBIJANJE Blob-A, MOJE CAPTURED SLIKE

> ISPITACU OVO JEDNO MPRILIKOM, ZA SADA KORISTIM UTITLIYP METODU, KOJU SAM OBEZBEDIO U utility.js FAJLU

## NAIME JA BIH SADA ZELEO DA UPLOAD-UJEM IMAGE, ODNOSNO ONU Blob INSTANCU, KOJU REFERENCITA picture VARIJABLA; ALI KAKO TO URADITI :question:

KAKO UPLOAD-OVATI SLIKU NA MOJ SERVER?

JA VRSIM INTERAKCIJU SA MOJIM SERVER-OM, UGLAVNOM PUTEM SERVICE WORKER-A

TAMO KORISTIM BACKGROUND SYNCHRONIZATION

sw.js (BACKGROUND SYNC DEO, KOJI SAM DEFINISAO KADA SAM SE BAVIO BACKGROUND SYNCHRONIZATIONOM)

```javascript
self.addEventListener('sync', function(ev){

    if(ev.tag === 'sync-new-post'){  

        ev.waitUntil(
            /*samo na pominjem da je sledeca metoda uvezena iz utility.js*/
            readAllData('sync-posts')

            .then(dataArray => {

                for(let data of dataArray){

                    fetch('https://us-central1-instapwaclone.cloudfunctions.net/storePostData', {
                        method: "POST",
                        body: JSON.stringify({
                            id: data.id,
                            title: data.title,
                            location: data.location,

                          // OVDE SAM RANIJE DEFINISAO DA SE SALJE
                          // DUMMY PICTURE; CISTO NAPOMINJEM
                            image: 'https://firebasestorage.googleapis.com/v0/b/instapwaclone.appspot.com/o/burgers_food.jpeg?alt=media&token=001349ec-8c02-4c16-87df-9db24b252256'
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        }
                    })
                    .then(resp => {
                        console.log("Send Data: ", resp);

                        if(resp.ok){
                            /*samo na pominjem da je sledeca metoda uvezena iz utility.js*/
                            deleteItemFromData('sync-posts', data.id)

                        }

                    })
                    .catch(function(err){
                        console.log('Error, while sending data', err)
                    })

                }
            })
        );
    }
})
```

**JA USTVARI SALJEM MOJE JSON PODATKE DO CLOUD FUNCTION-A, DAKLE FUNCTION-A NA SERVERU, I TAJ FUNCTION, ONDA VRSI STORING DATA U DATABASE** (TO BI TREBALO DA MI BUDE JASNO)

PRIKAZACI JOS JEDNOM, POMENUTU CLOUD FUNKCIJU

functions/*index.js* FAJL:

```javascript
const functions = require('firebase-functions');

const admin = require('firebase-admin');
const cors = require('cors')({
    origin: true
});


const serviceAccount = require("./instaclone-fb-key.json");


const webpush = require('web-push');


const privateVapidKey = "oC8DBLahIEnXnAMEzbmom6BtrF6z";  // lazni kljucevi zbog sigurnosti
const publicVapidKey = "BMfwPHbn5_YXc0wZZu5xEIIhs40w8CDWGnf2HSq-vAGVOZMLh-vS_m122NEFkIgcDW";

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://instapwaclone.firebaseio.com/"
});

exports.storePostData = functions.https.onRequest(function (request, response) {
	  
	cors(request, response, function () {
    	admin.database().ref('posts').push({
      		id: request.body.id,
      		title: request.body.title,
      		location: request.body.location,
      		image: request.body.image
    	})
		.then(function () {
			webpush.setVapidDetails(
				"mailto:bajic.rade2@gmail.com",
				publicVapidKey,
				privateVapidKey
			);
			return admin.database().ref('subscriptions').once('value');
		})
		.then(function (subscriptions) {
			subscriptions.forEach(function (sub) {
				var pushConfig = {
					endpoint: sub.val().endpoint,
					keys: {
						auth: sub.val().keys.auth,
						p256dh: sub.val().keys.p256dh
					}
				};

				webpush.sendNotification(
					pushConfig, 
					JSON.stringify({title: 'New Post', content: 'New Post added!', openUrl: '/help'}
				))
				.catch(function(err) {
					console.log(err);
				})

			});
			
			return response.status(201).json({message: 'Data stored', id: request.body.id});
		})
		.catch(function (err) {
			response.status(500).json({error: err});
		});
  
	});
});
```

## JA BI SADA TREBALO DA REDEFINISEM, POMENUTI CLOUD FUNCTION, KAKO ONA VISE NE BI ACCEPT-OVALA JSON PODATKE, VEC FORM DATA

TO JE ZATO STO FORM DATA MENI DOZVOLJAVA DA MIX-UJEM NORMALNE KEY-VALUE PAROVE SA FAJLOVIMA

TAMO GDE SAM DEFINISAO STRING URL-A, ZA IMAGE; TO VISE NE BI TREBAL ODA BUDE STRING WHEN RECEIVEING DATA, TO BI SADA TREBALO DA BUDE REAL FILE

DAKLE TREBAM DA BUDEM U MOGUCNOSTI DA POSALJEM RAZLICIT FORMAT

## ALI I ONI PODACI, KOJI SE SALJU, ODNOSNO TAMO SVUGDE GDE SAM DEFINISAO POST REQUEST, JA USTVARI TREBAM DA KORISTIM FormData INTERFEJS

[GOVORIO SAM OVDE O NJEMU](https://github.com/Rade58/apis_trying_out_and_practicing/blob/master/PROGRESSIVE%20WEB%20APPS/IMPORTANT%20PWA%20NOTES/fetch%20API%20%28PODSECANJE%20I%20DODATNA%20ZAPAZANJA%29/4.%20'POST'%20REQUEST.md#formdata-interfejs)

DAKLE, I U SERVICE WORKER-U, ALI I U fedd.js , ODNOSNO FAJLU, KOJI JE CONNECTED SA DOM-OM I U KOJEM SAM DEFINISAO POST REQUEST, KAO FALLBACK, KADA BROWSER NE PODRZVA BACKGROUND SYNC, ODNOSNO NE PODRZAVA SERVICE WORKER-E JA MORAM DEFINISATI POST REQUESTM, UZ POMOC FormData INTERFACE-A