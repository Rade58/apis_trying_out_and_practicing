# MIDDLEWARE HOOKS: Pre, Post I Async

KAK ODOBITI NOTIFIKACIJE, AK OSE NESTO DOGODI NA COLLECTION-U; I U SKLADU SA TIM RESPOND-OVATI

MONGOOSE-OV ODGOVOR NA TO SU **HOOKS** (*ZOVU IH USTVARI MIDDLEWARE, AL ISCOT MIOOSS IH ZOVE HOOKS*)

**DAKLE MOZES DODATI MIDDLEWARE INTO DIFFERENT EVENTS, KOJI SE DOGADJAU NA COLLECTION-U**

EVENT JE PRETTY MUCH BILO KOJI OPERATION, KOJI SE MOZE DOGODITI: find, findOneAndDelete, a save a remove

SVI DAKLE DIFFERENT TYPES OF OPERATIONS, KOJE MOGU DFA RADIM NA MODELU

- MOGU TIE-OVATI INTO THEM BEFORE THEY HAPPEN, ILI AFTER THEY HAPPEN

- I MOGU BITI SINHTONE I ASINHRONE

- MOGU KONTROLISATI I ORDER KADA CE SE DOGODITI

OPET CU KORISTITI PRIMER KOJI SAM KORISTIO I U PROSLOM MD FAJLU

POKAZUJEM SADA NJEGOVU POSTAVKU

```javascript
const school = new mongoose.Schema({
  name: String,
  openSince: Number,
  students: Number,
  isGreat: Boolean,

  stuff: [{type: String}]

})

school.virtual('stuffCount')
  .get(function(){
    console.log('inside getter')
    return this.stuff.length
  })



const School = mongoose.model('school', school)

connect()
  .then(async connection => {

    try{



    }catch(error){
        console.error(error)
    }

  })
  .catch(error => {
    console.error(error)
  })
```

## AKO ZELIM DA RUNN-UJEM MIDDLEWARE BEFORE CREATING-A DOKUMENTA, TO MOGU URADITI; BEFORE IT IS SAVED IN DATABASE I WANT TO RU NSOME MIDDLEWARE

KORISTICU ISTU Schema INSTANCU, KOJU SAM KREIRAO

ONO STO KORISTIM JESTE **pre** METODA *KOJOJ PASS-UJEM NAME OF THE EVENT, KOJI ZELIM DA SE SUBSCRIBE-UJEM*

KONKRETNO  UOVOM SLUCAJU MENI TREBA **'save'** EVENT

I ONDA DEFINISEM SOME FUNCTIONALITY, KOJI TREBA DA SE TRIGGER-UJE PRE NEGO STO JE DOKUMENT SAVED U DATBASE-U

```javascript
const school = new mongoose.Schema({
  name: String,
  openSince: Number,
  students: Number,
  isGreat: Boolean,

  stuff: [{type: String}]

})

school.virtual('stuffCount')
  .get(function(){
    console.log('inside getter')
    return this.stuff.length
  })

// EVO DEFINISEM MIDDLEWARE, KOJ ITREBA DA SE INVOCIRA PRE CREATA DOKUMENTA U KOLEKCIJI (U OVO MSLUCAJU 
// U PITANJU JE schools KOLEKCIJA)

school.pre('save', function(){
  console.log('before save')
})


const School = mongoose.model('school', school)

connect()
  .then(async connection => {

    try{

      // MOZES OVO TESTIRATI TAK OSTO CES KREIRATI JEDAN DOKUMENT
      // PRE NEG OSTO JE SAVED U DATABASE, SLEDECI DOKUMENT RUNN-OVAO SE MIDDLEWARE

      const school = await School.create({name: 'Funny', students: 48})

      console.log(school)   // OVO SE TEK POSLE STAMPALO

    }catch(error){
        console.error(error)
    }

  })
  .catch(error => {
    console.error(error)
  })

```

*****

**VAZNA NAPOMENA**

*NE KORISTI ARROW FUNKCIJE ZA MIDDLEWARE (HOOK-OVE), KA OSTO IH NISI KORISTI KADA SI DEFINISAO GETTER-A*

*****

*DAKLE FUNKCIJA SE IZVRSILA PRE SAVE, **ALI ONA SE NIJE IZVRSILA PRE VALIDACIJA*** (OVO JE BITNO DA SHVATIS)

## AKO ZELIS DA RAN-UJES HOOK PRE MONGOOSE-OVE VALIDACIJE, MOZES KORISTITI EVENT 'validete', SA pre METODOM

>> BEFORE YOU VALIDATE, LET ME VALIDATE FIRST, AND YOU CAN DO YOUR THING

DOBRO MESTO DA SE ODRADI ADVANCED CUSTOM VALIDACIJA

## PRETTY MUCH ZA BILO KOJU OPERACIJU KOJU MOZES DA URADIS NA MODELU, POSTOJI I HOOK (MIDDLEWARE) FOR IT

NA PRIMER KADA KORISTIS **'findOne'** EVENT SA pre METODOM, TO ZNACI DA CE SE MIDDLEWARE IZVRSITI BEFORE FINDINGA DOKUMENTA

## POSTOJE SOME GOTCHAS IZMEDJU QUERYING-A I UPDATE-INGA 

ZA TO MOZES DA ODES U DOKUMENTACIJU I POGLEDAS

U SUSTINI, MOZE SE DESITI DA this BUDE REFERENCA ZA DOKUMENT, ILI UPDATE THAT'S COMMING IN

ZAVISI OD TOGA KAK OSTRUCTURE-UJES APLIKACIJU

I OPET STOJI NAPOMENA DA NE KORISTIS ARROW FUNCTIONS

## KAO STO POSTOJI pre, TAKO POSTOJI I **post**

```javascript
  // EVO SAD MIDDLEWARE-A KOJI CE SE IZVRSITI POSLE CREATIN-A DOKUMENTA
school.post('save', function(doc){        // IMAS I INSTANCU Document-A, KAO PARAMETAR
  console.log('after save')
})
```

## GOVORIO SAMO SINHRONIM MIDDLEWARE FUNKCIJAMA; ISTO TAKO JA MOGU DEFINISATI I ASINHRONE

AKO DEFINISEM ASINHRONE, A PRI TOME SAM ORADIM SAVES AND READS, ONDA KORISTIM MIDDLEWARE-OV ARGUMENT next

**BITNO JE DA SE TAJ next POZOVE NA KRAJU ASINHRONE OPERACIJE, AKKO BI SE *INICIRAO PRELAZAK NA SLEDECI MIDDLEWARE***

```javascript
school.post('save', function(doc, next){ // IMAS next ARGUMENT

                      // USTVARI KAO I KOD MNOGIH NODE LIBRARY-JA DVA ARGUMENTA ZNACE DA JE ASYNC 
                      // OPERACIAJ (ISPITAJ OVO MALO BOLJE)

    // DAKLE AKO DEFINISE MDRUGI ARGUMENT MOONGOSE CE ZNATI DA JE U PITANJU ASINHRONA OPERACIJA

  // doc ARGUMENT JE SAMA INSTANCA Document-A

  Promise.resolve()
    .then(function(){
      
      console.log('jos nesto asinhrono', doc  )

      // POZIVAM next

      next()      // DA NISAM POZAVA SLEDECI STACKED MIDDLEWARE NE BI BIO POZVAN

    })

})
```

*GORNJI CODE JE MAL OSTRANGE ALI NAVICICU SE*

I SAM AUTOR WORKSHOPA NE VOLI OVAKVO PISANJE ASINHRONIH STVARI (KAO STO JE REKAO: BOLJE BI BILO DA MIDDLEWARE RETURN-UJE PROMISE)

## DAKLE JA MOGU STACK-UP-OVATI ONOLIKO MIDDLEWARE, KOLIK OZELIM, I ORDER PO KOJEM CE SE POZIVATI CE BITI ORDER PO KOJI MSAM IH, RANIJE DEFINISAO

POZIVANJE next() JE SAYING: 'POZOVI SLEDECI MIDDLEWARE, JE JA SAM DONE'

AKO UPOREDIS SA EXPRESS-OM I NJGOVIM MIDDLEWARE-IMA, POPRILICNO JE ISTO

## ON OSTO MOZES DA RADIS INSIDE MIDDLEWARE, JESTE OTHER DATBASE STUFF, STO JE PRILICNO HELPFUL

TO CU JA I RADITI

>>>> well, if we're doing these associations and I delete something but now the model that's referred to some of this is deleted, how do I clean that up?
>>>> You would do it in this middleware. So if you delete something, you need to go query the database for all the things that are referencing it and delete the reference too, or whatever you do there. So this is where you would do that. this is what this is built for.

E TI BI TO RADIO U MIDDLEWARE-U

## AKO RADIS WEBSOCKET SA REALTIME-OM, MIDDLEWARE BI BIO DOBRO MESTO ZA UPDATING CLENATA

AKO JEDAN CLENT UPDATE-UJE CHAT, I TI MORAS DA POST-UJES TAJ MESSEGE INSIDE EVERYON ELSES CHAT, TI BI TO URADIO U MIDDLEWARE-U